---
layout: post
title: "《衍生证券教程》第七章 远期、期货和交换期权"
description: ""
author:     "Hao"
category: true
tagline: "衍生品"
tags: [finance math , derivativ ,pricing]
---
格式更好的[html版本](https://www.fanghao.work/2025/11/28/Chapter7-%E8%BF%9C%E6%9C%9F-%E6%9C%9F%E8%B4%A7%E5%92%8C%E4%BA%A4%E6%8D%A2%E6%9C%9F%E6%9D%83/)

Margrabe公式是用一种资产交换另一种资产的期权公式，标准看涨期权和看跌期权是用现金交换资产或者资产交换现金，是交换期权的一个特例。
可以从Margrabe公式推导出Black公式，Black公式是以远期和期货为标的的期权公式。
可以从Black公式推导出Merton公式，Merton公式是不存在常数无风险利率情况下的看涨期权和看跌期权公式。
==本章将不再嘉定存在无风险资产==，这意味着市场是不完全的，存在多个风险中性测度。
经典的Black-Scholes公式：

$$
e^{-qT}S(0)N(x)-e^{-rT}KN(y) \tag{7.1a}
$$

其中

$$
x=\frac{\log{\frac{S(0)}{K}}+(r-q+\frac{1}{2}\sigma^2)T}{\sigma\sqrt{T}} \tag{7.1b}
$$

$$
y=x-\sigma\sqrt{T} \tag{7.1c}
$$

注意$e^{-qT}S(0)$是当期被执行时所得到的股票在0时的现值，是为在T时能够得到一份股票在0时需要付出的成本，在T时得到的股票中不包含其间的红利支付。
显然，$e^{-rT}K$是期权被执行时需要支付现金的现值。
此外，x等于

$$
\frac{\log(\frac{e^{-qT}S(0)}{e^{-rT}K})+\frac{1}{2}\sigma^2T}{\sigma\sqrt{T}}
$$

分子中对数的自变量是两个现值的比值。
本章所有的期权定价公式都具有相同的形式：
==未来得到的资产现值乘以$N(x)$，减去要交付的资产现值乘以$N(y)$，并且在各种情况下，x总是等于两个现值比值的对数加上$\frac{1}{2}\sigma^2T$，再除以$\sigma\sqrt{T}$，而y总是由(7.1c)得到。==

以看跌期权为例：
公式：

$$
e^{-rT}KN(-d_2)-e^{-qT}S(0)N(-d_1) \tag{7.2a}
$$

其中

$$
\begin{aligned}
x&=-d_2\\
&=-\frac{\log(\frac{S(0)}{K})+(r-q-\frac{1}{2}\sigma^2)T}{\sigma\sqrt{T}}\\
&=\frac{\log(\frac{e^{-rT}K}{e^{-qT}S(0)})+\frac{1}{2}\sigma^2T}{\sigma\sqrt{T}}
\end{aligned} \tag{7.2b}
$$

$$
\begin{aligned}
y&=-d_1\\
&=-\frac{\log(\frac{S(0)}{K})+(r-q+\frac{1}{2}\sigma^2)T}{\sigma\sqrt{T}}\\
&=x-\sigma\sqrt{T}
\end{aligned} \tag{7.2c}
$$

## Margrabe公式

考虑价格分别为$S_1$和$S_2$的两种资产以及在时刻T用资产2交换资产1的一份欧式期权。
期权在到期日的价值为

$$
\max(0,S_1(T)-S_2(T))
$$

注意，看涨期权和看跌期权并没有实质性差别：交换期权既可以看做以第一种资产为标的、执行价格为随机变量$S_2(T)$的看涨期权，也可以看作以第二种资产为标的、执行价格为随机变量$S_1(T)$的看跌期权。
假设资产的红利支付率为常数$q_i$，资产价格满足方程

$$
\frac{dS_i}{S_i}=\mu_idt+\sigma_idB_i
$$

其中$B_i$为实际概率测度下的布朗运动。
漂移项$\mu_i$可以是很一般的随机过程，波动率$\sigma_i$和两个布朗运动的相关系数$\rho$可以是随机过程。不过需要假定由

$$
\sigma=\sqrt{\sigma_1^2+\sigma_2^2-2\rho\sigma_1\sigma_2} \tag{7.3}
$$

定义的$\sigma$为常数。
由(2.40)可知，$\sigma$是$S_1/S_2$的波动率（也是$S_2/S_1$的波动率）。因此，这相当于假定资产价格比值的波动率为常数。
==margrabe公式为：==
T时交换两种资产的欧式期权价值为

$$
\boxed{e^{-q_1T}S_1(0)N(d_1)-e^{-q_2T}S_2(0)N(d_2)} \tag{7.4a}
$$

其中

$$
d_{1}=\frac{\log\left(\frac{S_{1}(0)}{S_{2}(0)}\right)+\left(q_{2}-q_{1}+\frac{1}{2}\sigma^{2}\right)T}{\sigma\sqrt{T}} \tag{7.4b}
$$

$$
d_{2}=d_{1}-\sigma\sqrt{T} \tag{7.4c}
$$

可以取第二种资产的单位资产作为“货币”，即用第二种资产为计价物。采用第二种资产为计价物时，第一种资产的价值为$S_1/S_2$。交换期权在到期日的价值为

$$
\max(0,S_1(T)-S_2(T))=S_2(T)\max(0,\frac{S_1(T)}{S_2(T)}-1)
$$

这是以自然货币计价的期权价值。
如果上式除以$S_2(T)$就得到以第二种资产为计价物的期权价值，即

$$
\max(0,\frac{S_1(T)}{S_2(T)}-1)
$$

而这是一个标准看涨期权的价值。
使用标准Black-Scholes公式计算得到的价值乘以$S_2(0)$就是以自然货币计价的期权价值。
以第二种资产为计价物时，无风险收益率等于第二种资产的红利支付率$q_2$。
第一种资产的红利支付率仍然是$q_1$。以自然货币计价时，资产在瞬时时间间隔dt上的红利支付为$q_1S_1(t)dt$，采用第二种资产为计价物时的红利支付值为$[q_1S_1(t)/S_2(t)]dt$，等于以第二种资产为计价物时第一种资产的价值$S_1(t)/S_2(t)$乘以$q_1 dt$.
以第二种资产为计价物时的第一种资产的波动率等于比值$S_1(t)/S_2(t)$的波动率，即（7.3）。
以上述参数作为输入项，采用Black-Scholes公式可以直接得出Margrabe公式。

## Black公式

Black公式给出了确定性（即非随机性）利率条件下以期货合约为标的的期权价值。
**当利率为确定性时，期货价格应该等于远期价格。**
因此，Black公式也给出了确定性（即非随机性）利率条件下以远期合约为标的的期权价值。
因为以远期为标的的期权价值公式具有更为广泛的实用性（即使在利率随机变化的情况下仍然适用），因此现在谈到Black公式时，更多地是指以远期为标的的期权价值公式。
定义：
持有远期看涨期权多头的投资者，可以在期权到期日$T$行权，从而以期权执行价格（即远期价格）在远期合约到期日$T'(T' \geq T)$买入标的资产并支付对应价款。
即，看涨期权的执行将产生一个远期合约多头，合约价格等于期权的执行价格；远期合约多头意味着投资者在$T'$将获得标的资产，同时支付远期合约的价格（即期权的执行价格）。因此，**执行价格不再合约执行时支付，而是在标的资产转交时支付。**
对称地，看跌期权的执行将产生一个远期合约空头，合约价格等于期权的执行价格，这意味着在$T'$合约执行者交付标的资产，同时得到执行价格规定的现金。
用$F(t)$表示远期的市场价格，并假定远期价格满足

$$
\frac{dF}{F}=\mu dt+\sigma dB \tag{7.5}
$$

当假定利率是随机的，Black公式尤其有用。现在不假设存在一个常数无风险利率，而是假设存在一个“贴现债券”，该债券在时间$T'$支付\$1.（之所以称为“贴现债券”，是因为其价格在计算$T'$时发生的非随机现金流的现值时可以作为合适的贴现因子），这样的债券又称为“零息债券”。用$P(t,T')$表示债券t时的价格。
Black公式为：

---

设远期合约到期日为$T'$，以该合约为标的、执行价格为K、到期日为T的欧式期权在0时的价值为

$$
\boxed{\text{看涨期权价格}=P(0,T')F(0)N(d_1)-P(0,T')KN(d_2)}\tag{7.6a}
$$

$$
\boxed{\text{看跌期权价格}=P(0,T')KN(-d_2)-P(0,T')F(0)N(-d_1)}\tag{7.6b}
$$

其中

$$
d_1=\frac{\log(\frac{F(0)}{K})+\frac{1}{2}\sigma^2T}{\sigma\sqrt{T}} \tag{7.6c}
$$

$$
d_2=d_1-\sigma\sqrt{T} \tag{7.6d}
$$

---

Black公式只是Margrabe公式的一个简单结果。
首先需要对以远期合约为标的的期权在其到期日T的价值进行分析。
考虑看涨期权的情形。看涨期权执行将产生一个远期价格为K的远期合约多头头寸。要注意，远期合约的价格是在标的资产交付时间$T'$才进行支付的。因此，假定你执行一份看涨期权，然后以市场价$F(T)$卖出一份远期合约，则交付和收到的远期合约多头头寸与空头头寸相互抵消，使得在$T'$支付K美元，并在$T'$时得到$F(T)$美元。T时净现金流的价值为$P(T,T')[F(T)-K]$，即合约执行时期权的价值，因此看涨期权在T时的价值为

$$
\max(0,P(T,T')[F(T)-K])=\max(0,P(T,T')F(T)-P(T,T')K) \tag{7.7}
$$

上式也可以写为

$$
\max(0,S_1(T)-S_2(T)) \tag{7.8}
$$

其中$S_1(T)$和$S_2(T)$定义为

$$
S_1(t)=P(t,T')F(t),S_2(t)=P(t,T')K \tag{7.9}
$$

在t=T处的值。因此，以远期合约为标的的看行期权的到期日价值（T时），是价格为$S_1$和$S_2$的两种资产的互换期权的到期日价值（T时）。
由此可以得出，以远期合约为标的的看涨期权的0时价值，是两种资产互换期权的0时价值。

现在考虑以远期合约为标的的看跌期权。执行一份看跌期权同时以市场价$F(T)$买入一份远期合约来抵减远期合约空头头寸，由此得出在远期合约到期日$T'$时收到的净现金流为$K-F(T)$。因此，看跌期权在到期日的价值为

$$
\max(0,P(T,T')[K-F(T)])=\max(0,S_2(T)-S_1(T)) \tag{7.10}
$$

因此，以远期合约为标的的看跌期权的0时价值，必定为一个交换期权的0时价值。

在Margrabe公式的推导中，关键假设是资产价格比值的波动率为常数。以远期合约为标的的看涨期权对应的比值为$S_1/S_2=F/K$，K为常数，因此比值的波动率等于远期价格F的波动率$\sigma$，而我们已经在（7.5）假定$\sigma$为常数。以远期合约为标的的看跌期权对应的比值为$S_2/S_1=K/F$，由伊藤公式得出

$$
\begin{aligned}
\frac{d(K/F)}{K/F}&=-\frac{dF}{F}+(\frac{dF}{F})^2\\
&=(-\mu+\sigma^2)dt-\sigma dB\\
&=(-\mu+\sigma^2)dt+\sigma(-dB)
\end{aligned}
$$

在Margrabe公式中取$S_1(0)=P(0,T')F(0),S_2(0)=P(0,T')K,q_1=0,q_2=0$，即可得出以远期合约为标的的看涨期权价格的Black公式(7.6a)。
看跌期权是一个相反的互换期权，因此由Margrabe公式得出(7.6b)。

现在解释为什么(7.9)定义的$S_1$和$S_2$是资产价格，并且因为在应用Margrabe公式时取$q_1=q_2=0$，$S_1$和$S_2$实际上是无红利支付的资产价格。

- $S_2$：K单位$T'$到期的贴现债券的价格
- $S_1$：在0时构建并持有到时间T的如下投资组合的价格：一份远期合约多头，同时买入$F(0)$单位到期日为$T'$的贴现债券，在t时，投资组合中债券的价值为$F(0)P(t,T')$；而远期合约多头的价值可以通过在t时以市场价格$F(t)$卖出一份远期合约来抵减远期合约多头头寸看出，这样的操作抵消了标的资产的交、收责任，产生$T'$时的净现金流收入$F(t)-F(0)$，现金流在t时的价值为$P(t,T')[F(t)-F(0)]$，与债券价值相加得出$P(t,T')F(t)=S_1(t)$。

以远期合约为标的的期权看涨-看跌评价关系为

$$
\text{看涨期权价格}+P(0,T')K=\text{看跌期权价格}+P(0,T')F(0)
$$

## Merton公式

现在讨论**不再假定存在常数无风险利率时**的Black-Scholes公式，取而代之的是**假定存在一个与期权具有相同到期日的贴现债券**。
设期权和贴现债券的到期日为T，将t时$(t \leq T)$的贴现债券写为$P(t,T)$。我们仍假定股票的红利支付率为常数q，但对波动率做出不同的假设--不再假设股票的波动率为常数，而是假定远期价格的波动率为常数。
以股票远期合约为例，到期日与期权到期日T相同。用$F(t)$表示时间$t(t \leq T)$的远期价格。因为合约到期日的远期价格必等于现货价格，因此$F(T)=S(T)$。
考虑一份以远期合约为标的的看涨期权，远期合约到期日与看涨期权到期日T相同，按上一节的符号，即$T=T'$，因此$P(T,T')=1$。因此，以远期为标的的看涨期权在到期日$T$的价值(7.7)为

$$
\max(0,F(T)-K)=\max(0,S(T)-K)
$$

与以股票为标的的看涨期权价值相同。因此，以股票为标的的看涨期权的0时价值与以远期为标的的看涨期权的0时价值相同，因而可以用远期为标的的看涨期权Black公式(7.6a)来对股票为标的的看涨期权进行定价，当然需要假定远期价格的波动率为常数。

> - ### 1\. 在讲解Merton公式前，首先提到这些内容的目的是什么？
> - **核心目的：实现从“现货定价框架”到“远期定价框架”的范式转换，并为Merton公式在非恒定利率环境下的应用扫清障碍。**
> - 具体来说，这个铺垫有以下几个层面的深意：
> - - **放宽Black-Scholes模型的严格假设：** 标准的Black-Scholes模型假设无风险利率是恒定不变的。这在现实中几乎不成立。作者首先指出要放弃这个假设，承认利率是可变的，这使得模型更贴近现实。这是模型扩展的第一步。
>
>     ```
>     - **引入关键工具——折现债券P(t,T)：** 为了处理可变的利率，作者引入了与期权同时到期的折现债券 `P(t,T)`。这个工具至关重要，因为它充当了“时间机器”，可以将未来T时刻的现金流（如执行价格K）准确地折现回当前t时刻的价值。在利率可变的情况下，你不能简单地使用一个恒定的 `r`来进行折现，而 `P(t,T)`本身就蕴含了从当前时刻到到期日整个期间的利率期限结构信息。
>
>     - **将焦点从“股票价格波动率”转向“远期价格波动率”：** 这是最精妙的一步。当利率变化时，即使股票本身的波动率恒定，其远期价格的波动率也会因为折现因子 `P(t,T)`的波动而变得复杂。作者在这里做了一个关键的建模选择：**直接假设“远期价格”的波动率是恒定的（或确定性时变的）**，而不是去假设“股票价格”的波动率是恒定的。
>
>     - - **这样做的好处是：** 它将所有关于利率的不确定性“打包”进了远期价格 `F(t)` 之中。在后续推导Merton公式时，我们只需要关心 `F(t)` 的行为，而无需再分别处理股票价格和利率的随机过程，极大地简化了问题。
>
>     ```
>
>     虽然在远期空间里我们仍然做了波动率恒定的假设，但这一转换的**意义非常重大**。它本质上是一种“问题降维”，将复杂问题转化到了一个更合适的平台上进行处理。
>
>     下面这个表格清晰地对比了在“现货空间”和“远期空间”下定价的核心差异。
>
>     ```
>
>     - | 对比维度 | 现货定价框架 (传统BS思路) | 远期/期货定价框架 (Merton公式思路) |
>     | --- | --- | --- |
>     | **核心变量** | 标的资产现货价格 $S_t$ | 标的资产远期价格 $F(t, T)$ |
>     | **波动率假设** | 假设现货价格波动率 $\sigma_S$ 恒定 | 假设**远期价格波动率** $\sigma_F$ 恒定 |
>     | **利率与股息处理** | 需明确输入无风险利率 $r$ 和股息率 $q$ | 利率和股息的影响已**隐含**在远期价格 $F(t, T)$ 中 |
>     | **模型复杂度** | 较高，需精确估计多个参数 | 较低，焦点集中于远期价格的波动性 |
>     | 计算复杂度（非恒定环境） | 高，需要对利率和股息的未来路径进行复杂的积分或模拟 | 低，仅依赖当前市场可观测的远期价格和折现因子 |
>     | 关键简化工具 | 无   | **折现债券** *P*(*t*,*T*)，用于将未来价值无偏地折现至今 |
>     | **适用性** | 当利率和股息率不确定或可变时，模型会变得复杂 | **特别适用于处理可变利率和股息率的环境** |
>
>     -  转换的意义与优势：
>
>     -  从表格可以看出，转换到远期空间进行定价，主要带来了以下几方面的关键优势：
>
>     - 1.  **简化模型输入，提升稳健性** 在现货框架下，期权价格对利率和股息率的估计误差非常敏感。而转换到远期空间后，远期价格 $F(t, T)$ 本身就是一个由市场决定的、包含了市场对未来利率和股息预期综合信息的变量。使用它作为定价基础，相当于直接用市场共识来抵消这些额外变量的不确定性，使模型在面对不确定的利率环境时更加**稳健** 。
>     2.  **聚焦核心风险因子** 对于许多以期货为标的的期权（如商品期权、股指期货期权），其价格直接与远期合约挂钩。在这些情况下，远期价格本身就是更直接、更相关的标的变量。在此框架下定价，能够更清晰地**聚焦于核心风险因子**——远期价格本身的波动。
>     3.  **为更复杂的模型铺平道路** 将定价框架建立在远期空间上，是许多现代高级金融模型的基础。例如在利率期权领域著名的**LIBOR市场模型**，以及商品衍生品定价中的**远期曲线模型** ，都是直接对整条远期曲线（即不同到期日的远期价格）的动态变化进行建模。因此，掌握在远期空间下的定价思想，是理解这些更复杂模型的重要阶梯。
>     - ### 🔁 从恒定到随机：模型的自然演进
>
>     - 当然，你可能会想到，假设远期波动率恒定仍然是对现实的简化。确实如此，这可以看作是模型演进过程中的一步：
>
>     - - **基础模型**：在远期空间下假设波动率恒定，这已经是比在现货空间下更优的选择。
>     - **高级模型**：为了捕捉“波动率微笑”等更复杂的市场现象，可以进一步将模型扩展为**随机波动率模型**（如Heston模型 ）或**局部波动率模型** 。这些高级模型往往同样是在远期空间的框架下进行构建和推导的。
>     - 所以，从现货定价到远期定价的转换，是一个关键的**范式转换**。它并没有彻底解决波动率的问题，但通过巧妙地重组变量，它将一个多变量的复杂问题，简化成了一个以远期价格波动为核心的、更干净、更聚焦的问题。
>
>     - ### 深入理解Merton公式的简化逻辑
>
>     - Merton公式的精妙之处在于，它进行了一次关键的**问题转换**（Paradigm Shift）：
>
>     - 1.  **从“现货空间”到“远期空间”**：经典BS模型在“现货空间”中工作，必须显式地处理利率和股息这两个变量及其未来的不确定性。而当这些变量不恒定时，问题会变得非常复杂，可能涉及对它们未来所有可能路径的积分。
>
>     而Merton的框架则将定价问题转移到了“远期空间”。远期价格 *F*(*t*,*T*)本身就是一个由市场决定的、包含了市场对所有未来不确定性（包括利率变化、股息支付）综合预期的变量。
>
>     2.  **折现债券 P(t,T)的核心作用**：`P(t,T)`是此转换的基石。它代表了当前市场对从现在到期权到期日 `T`之间的无风险折现因子。这个单一的数值已经蕴含了整个期限内的利率期限结构信息。在使用Merton公式时，您不需要知道利率具体会如何变化，只需要知道这个总体的折现效果 `P(t,T)`即可。
>
>     3.  **聚焦核心风险源**：通过这种转换，模型将定价的焦点从“预测未来的利率和股息路径”转变为“评估远期价格 *F*(*t*,*T*)在到期前的波动性”。所有复杂的、多变量的不确定性被“打包”进了单一的远期价格及其波动率中。这使得模型在面对现实世界中不确定的利率和股息环境时，更加**稳健**和**实用**。
>
>     - ### 💡 现实意义与影响
>
>     - 这种简化具有重要的现实意义：
>
>     - - **实用性**：在实际交易中，交易员更关心以远期或期货合约为标的的期权的定价。Merton框架直接使用这些可观测的市场价格作为输入，避免了估计未来利率和股息的难题，使定价更快捷、更可靠。
>     - **理论桥梁**：这种在“远期空间”下定价的思想，为后来更复杂的金融模型（如利率衍生品领域的LIBOR市场模型）奠定了重要的基础。
>     - 总而言之，Merton公式通过切换到远期定价框架并利用折现债券 `P(t,T)`，将一个多变量的动态复杂问题，优雅地简化为一个主要依赖于远期价格波动的、更易于处理的问题。
>
>     - **总结一下这个目的：** 在引入Merton公式（用于支付连续股息的股票期权定价）之前，先建立一个更稳健、更通用的定价框架。这个框架通过使用远期合约和折现债券，巧妙地将复杂的、非恒定的利率问题，转化为一个关于远期价格的问题，从而为Merton公式在更现实条件下的应用铺平了道路。
>
>     * * *
>
>     - ### 2\. 假定远期合约的到期日和期权到期日相同，有什么用意？
>
>     - **核心用意：建立到期价值的等价性，从而为使用Black公式定价股票期权提供合法性。**
>
>     - 这个假设是整个逻辑链条的基石，其用意具体体现在：
>
>     - - **确保到期价值完全相同：** 根据远期合约的定义，在到期日T，远期价格 `F(T)` 必须等于标的资产的即期价格 `S(T)`。因此，一个执行价为K、到期日为T的**远期看涨期权**在到期时的收益为 `max(0, F(T) - K)`。而一个执行价为K、到期日为T的**股票看涨期权**在到期时的收益为 `max(0, S(T) - K)`。由于 `F(T) = S(T)`，这两个收益函数是完全一致的。 `远期看涨期权到期收益 = max(0, F(T) - K) = max(0, S(T) - K) = 股票看涨期权到期收益`
>     - **应用无套利原理：** 在到期日价值完全相同的两项资产，在当前时刻（0时刻）的价值也必然相同，否则就存在无风险的套利机会。因此，我们可以得出一个强有力的结论：**股票看涨期权的当前价值，必须等于与之对应的远期看涨期权的当前价值。**
>     - **打通使用Black公式的路径：** Black公式最初就是为远期/期货期权定价而设计的。既然我们已经证明了股票期权在价值上等同于一个特定（到期日相同）的远期期权，那么我们就可以“借道”Black公式来为股票期权定价。我们只需要将Black公式中的远期价格参数，替换为我们这里定义的股票远期价格 `F(t)` 即可。
>     - **总结一下这个用意：** 设定相同的到期日，是为了创造一个“完美映射”，使得股票期权的定价问题，可以完全等价地转化为一个我们已有现成解决方案（Black公式）的远期期权定价问题。这是一个非常巧妙的理论桥梁，极大地扩展了Black公式的应用范围。
>
>     - ### 总体结论
>
>     - 这段内容的核心思想是**问题转化**。它通过引入折现债券和远期合约，将一个在“现货空间”里很复杂的问题（非恒定利率下的股票期权定价），成功地转化为了一个在“远期空间”里更简单的问题（恒定波动率下的远期期权定价）。这样，就可以直接套用成熟的Black公式，从而优雅地推广了Black-Scholes-Merton模型。这是在讲解Merton公式之前，先建立一个更强大、更通用理论框架的典型做法。
>     ```

并不需要假设远期合约是可交易的，因为可以用股票合成远期合约。在t合成一份远期合约，需要买入$e^{-q(T-t)}$份股票，购买成本为$e^{-q(T-t)}S(t)$，将红利进行再投资，到T时累计为1份股票。用卖空$e^{-q(T-t)}S(t)/P(t,T)$单位贴现债券得到的收入作为购买股票的资金（在t时刻，到期时间为T的贴现债券价格为P(t,T)，故需要$e^{-q(T-t)}S(t)/P(t,T)$单位的贴现债券才能凑够股票的购买成本）。这样将产生时间T时的负债$e^{-q(T-t)}S(t)/P(t,T)$，因此买入的远期必须在交割日产生$e^{-q(T-t)}S(t)/P(t,T)$的收入，即远期价格为

$$
F(t)=\frac{e^{-q(T-t)}S(t)}{P(t,T)} \tag{7.12}
$$

要采用Black公式，需要假设

$$
\frac{dF}{F}=\mu dt+\sigma dB \tag{7.13}
$$

其中B是布朗运动，$\mu$可以是一般的随机过程，$\sigma$为常数。
在这个假设下，取$F(0)=e^{-qT}S(0)/P(0,T)$,从Black公式（7.6）立即可以得出如下公式：

---

设远期价格的波动率为常数$\sigma$，股票的红利支付率为常数q，则以股票为标的、到期日为T的欧式看涨期权和看跌期权在0时的价值为：

$$
\boxed{\text{看涨期权价格}=e^{-qT}S(0)N(d_1)-P(0,T)KN(d_2)} \tag{7.14a}
$$

$$
\boxed{\text{看跌期权价格}=P(0,T)KN(-d_2)-e^{-qT}S(0)N(-d_1)} \tag{7.14b}
$$

其中

$$
d_1=\frac{\log(\frac{S(0)}{KP(0,T)})-qT+\frac{1}{2}\sigma^2T}{\sigma\sqrt{T}} \tag{7.14c}
$$

$$
d_2=d_1-\sigma\sqrt{T} \tag{7.14d}
$$

---

将贴现债券价格用其收益率表示，贴现债券收益率y定义为：

$$
y=\frac{-log P(0,T)}{T} \Leftrightarrow P(0,T)=e^{-yT}
$$

(7.14)中带入上式可得：

---

设远期价格的波动率为常数$\sigma$，股票的红利支付率为常数q，则以股票为标的、到期日为T的欧式看涨期权和看跌期权在0时的价值为：

$$
\boxed{\text{看涨期权价格}=e^{-qT}S(0)N(d_1)-e^{-yT}KN(d_2)} \tag{7.15a}
$$

$$
\boxed{\text{看跌期权价格}=e^{-yT}KN(-d_2)-e^{-qT}S(0)N(-d_1)} \tag{7.15b}
$$

其中

$$
d_1=\frac{\log(\frac{S(0)}{K})+(y-q+\frac{1}{2}\sigma^2)T}{\sigma\sqrt{T}} \tag{7.15c}
$$

$$
d_2=d_1-\sigma\sqrt{T} \tag{7.15d}
$$

---

Merton公式是Black-Scholes公式的一个重要推广。实际中常见的做法，是用贴现债券收益率作为Black-Scholes公式中的无风险利率，而Merton公式表明，这样做是合理的。不过，对远期价格的波动率进行估计，然后用估计出的波动率作为Black-Scholes-Merton公式中的波动率的做法（由于无风险利率实际上并非常数，因此应该如此）在实际中并不常用。
但是，这对短期期权的定价并没有太大影响，因为短期债券价格的波动较低，**对于短期期权来说，短时间内远期价格的波动率近似等于标的资产的波动率。**
此外，当从Black-Scholes公式（以贴现债券收益率为无风险利率）中计算隐含波动率时，计算出的波动率可以看做市场对远期价格波动率的预期，因此以此作为Black-Scholes-Merton公式的输入项来对其他期权进行定价时十分恰当的（当然需要假定，市场将远期价格波动率看做常数）。

远期价格波动率可以通过股票波动率、债券波动率及其相关系数加以计算。
假定

$$
\frac{dS}{S}=\mu_sdt+\sigma_s dB_s
$$

$$
\frac{dP}{P}=\mu_pdt+\sigma_p dB_p
$$

其中$B_s$和$B_p$为布朗运动，相关系数为$\rho$。由（2.38）和（2.40）得出，$e^{-q(T-t)}S(t)/P(t,T)$的波动率为$\sigma$，$\sigma$定义为

$$
\sigma=\sqrt{\sigma_s^2+\sigma_p^2-2\rho \sigma_s \sigma_p} \tag{7.16}
$$

## 三者的核心差异对比表格：

| 对比维度                    | Margrabe 公式                                                                                                                                               | Black 公式                                                                                                      | Merton 公式                                                                                                                                                                            |
| --------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 适用场景                    | 欧式**交换期权**（到期以 “资产 2” 交换 “资产 1”）                                                                                                 | 欧式**远期 / 期货合约期权**（行权后持有远期多头 / 空头）                                                  | 欧式**股票期权**（放松 “无风险利率为常数” 的 Black-Scholes 推广）                                                                                                              |
| 定价对象                    | 期权到期价值：$\max(0, S_1(T)-S_2(T))$（资产 1 换资产 2 的权利）                                                                                          | 期权到期价值：$\max(0, P(T,T')F(T)-P(T,T')K)$（远期合约与现金的交换）                                         | 期权到期价值：$\max(0, S(T)-K)$（股票与现金的交换）                                                                                                                                  |
| 核心假设                    | 1\. 资产$S_1$、$S_2$支付固定股息率$q_1$、$q_2$  `<br>`2\. 资产价格比率的波动率$\sigma=\sqrt{\sigma_1^2+\sigma_2^2-2\rho\sigma_1\sigma_2}$为常数 | 1\. 远期价格$F(t)$的波动率$\sigma$为常数  `<br>`2\. 用贴现债券$P(t,T')$表示贴现因子（无风险利率可随机） | 1\. 股票支付固定股息率$q$  `<br>`2\. 股票远期价格$F(t)=\frac{e^{-q(T-t)}S(t)}{P(t,T)}$的波动率$\sigma$为常数  `<br>`3\. 用贴现债券$P(t,T)$表示贴现因子（无风险利率可随机） |
| 公式核心结构                | $e^{-q_1 T}S_1(0)N(d_1) - e^{-q_2 T}S_2(0)N(d_2)$（资产现值的差值）                                                                                       | $P(0,T')F(0)N(d_1) - P(0,T')K N(d_2)$（远期现值与行权价现值的差值）                                           | $e^{-qT}S(0)N(d_1) - P(0,T)K N(d_2)$（股票现值与行权价现值的差值）                                                                                                                   |
| 计价单位 / 贴现方式         | 以 “资产 2” 为计价单位，用股息率贴现资产价格                                                                                                              | 用贴现债券$P(0,T')$贴现远期价格与行权价                                                                       | 用股息率贴现股票价格，用贴现债券$P(0,T)$贴现行权价                                                                                                                                   |
| 股息率假设                  | 两种资产均有固定股息率$q_1$、$q_2$                                                                                                                      | 无股息率（远期 / 贴现债券无现金流）                                                                             | 股票有固定股息率$q$                                                                                                                                                                  |
| 波动率假设                  | 资产价格**比率**的波动率为常数                                                                                                                        | 远期价格的波动率为常数                                                                                          | 股票**远期价格**的波动率为常数                                                                                                                                                   |
| 推导基础                    | 基于 Black-Scholes 公式（将资产 2 作为计价单位）                                                                                                            | 基于 Margrabe 公式（将远期现值、行权价现值视为 “交换的两种资产”）                                             | 基于 Black 公式（将股票远期价格代入远期期权定价）                                                                                                                                      |
| 退化为 Black-Scholes 的条件 | 资产 2 为现金（$S_2=K$）、$q_2=r$（现金的 “股息率” 为无风险利率）、$\sigma_2=0$（现金无波动）                                                       | 贴现债券满足$P(0,T')=e^{-rT'}$（无风险利率为常数）、远期价格$F(0)=e^{(r-q)T'}S(0)$                          | 贴现债券满足$P(0,T)=e^{-rT}$（无风险利率为常数）                                                                                                                                     |

## Margrabe公司、Black公式和Merton公式的典型应用

以下是每个公式的典型应用场景示例，结合实际金融需求说明用法：

1. Margrabe 公式：公司并购中的股票交换期权
   **场景**：A 科技公司计划并购 B 制造公司，约定 B 公司股东在 1 年后有权以 “1 股 B 公司股票” 交换 “0.5 股 A 公司股票”（欧式期权）。
   **参与方**：A 公司（期权卖方）、B 公司股东（期权买方）。
   **需求**：双方需要确定这份 “股票交换权利” 的当前价值，用于并购对价谈判。
   为什么用 Margrabe 公式：
   该期权的本质是 “以 B 股（资产 2）交换 A 股（资产 1）”，符合 Margrabe 公式 “两种资产互换” 的定价对象；同时 A 股、B 股均有稳定分红（对应$q_1$、$q_2$），且两者股价的相对波动率（$σ=σ_A^2+σ_B^2−2ρσ_Aσ_B$）可通过历史数据估算为常数，满足公式假设。
   **公式**：
   $\text{交换期权价值} = e^{-q_1 T} S_1(0) N(d_1) - e^{-q_2 T} S_2(0) N(d_2)$
   $d_1 = \frac{\log\left(\frac{S_1(0)}{S_2(0)}\right) + \left(q_2 - q_1 + \frac{1}{2}\sigma^2\right) T}{\sigma\sqrt{T}}, \quad d_2 = d_1 - \sigma\sqrt{T}$
   $\sigma = \sqrt{\sigma_1^2 + \sigma_2^2 - 2\rho\sigma_1\sigma_2}$
   **简化计算步骤**
   (1) **收集基础参数**

* $S_1(0)
  $：A 公司当前股价（如：100 美元 / 股）
* $S_2(0)
  $：B 公司当前股价（如：40 美元 / 股）
* $q_1$：A 公司股息率（如：分红 2 美元 / 股 → $q_1=2/100=2\%$）
* $q_2$：B 公司股息率（如：分红 1 美元 / 股 → $q_2=1/40=2.5\%$）
* $T$：期权期限（如：1 年）
* $\sigma_1$：A 公司股价波动率（历史数据→20%）
* $\sigma_2$：B 公司股价波动率（历史数据→15%）
* $\rho$：A、B 股价相关系数（历史数据→0.6）

(2) **计算相对波动率**

   $\sigma = \sqrt{0.2^2 + 0.15^2 - 2×0.6×0.2×0.15} ≈ 0.147$

(3) **计算**

   $d_1 = \frac{\log\left(\frac{100}{40}\right) + \left(0.025 - 0.02 + \frac{1}{2}×0.147^2\right)×1}{0.147×\sqrt{1}} ≈ 2.43$

   $d_2 = 2.43 - 0.147 ≈ 2.28$

(4) **查正态分布表得**

   $N(2.43)≈0.9925$，$N(2.28)≈0.9887$

(5) **计算期权价值**

   $\text{价值} = e^{-0.02×1}×100×0.9925 - e^{-0.025×1}×40×0.9887 ≈ 97.28 - 38.94=58.34\text{美元}$
2. Black 公式：大宗商品期货的看涨期权
**场景**：某航空公司预计 1 年后需要采购 100 万桶原油，为避免油价上涨风险，计划买入 “1 年后到期、行权价为 80 美元 / 桶的原油期货看涨期权”（行权后将获得 “以 80 美元 / 桶买入原油期货” 的多头头寸）。
**参与方**：航空公司（期权买方）、期货经纪商（期权卖方）。
**需求**：计算这份原油期货期权的当前成本，用于对冲预算。
为什么用 Black 公式：
该期权的标的是 “原油期货合约”，符合 Black 公式 “远期 / 期货期权” 的定价范围；同时原油期货价格的波动率（σ）可通过期货市场数据估算为常数，且用 “1 年期国债（贴现债券P(0,1)）” 作为贴现因子（无需假设无风险利率为常数），满足公式假设。
**公式**
$\text{期货看涨期权价值} = P(0,T') F(0) N(d_1) - P(0,T') K N(d_2)$
$d_1 = \frac{\log\left(\frac{F(0)}{K}\right) + \frac{1}{2}\sigma^2 T}{\sigma\sqrt{T}}, \quad d_2 = d_1 - \sigma\sqrt{T}$
(1) **收集基础参数**

* $F(0)$：当前原油期货价格（如：75 美元 / 桶）
* $K$：行权价（如：80 美元 / 桶）
* $T$：期权期限（如：1 年）
* $P(0,1)$：1 年期国债价格（贴现债券，如：95 美元 / 100 面值 → $P(0,1)=0.95$）
* $\sigma$：原油期货价格波动率（如：18%）

(2) **计算**

   $d_1 = \frac{\log\left(\frac{75}{80}\right) + \frac{1}{2}×0.18^2×1}{0.18×\sqrt{1}} ≈ -0.27$

   $d_2 = -0.27 - 0.18 ≈ -0.45$

(3) **查正态分布表得**

   $N(-0.27)≈0.3936$，$N(-0.45)≈0.3264$

(4) **计算期权价值**

   $\text{价值} = 0.95×75×0.3936 - 0.95×80×0.3264 ≈ 27.74 - 24.81 = 2.93\text{美元/桶}$
4. Merton 公式：新兴市场的长期股票期权
场景：某投资机构计划投资印度某科技股的 “5 年期欧式看涨期权”，行权价为当前股价的 120%。印度市场无风险利率波动较大（无法假设为常数），但可通过印度国债市场获取 “5 年期贴现债券价格P(0,5)”。
参与方：投资机构（期权买方）、印度券商（期权卖方）。
需求：确定该长期股票期权的合理定价，避免因利率波动导致估值偏差。
为什么用 Merton 公式：
该期权的标的是股票（符合 Merton 公式的定价对象），且印度市场无风险利率随机（用贴现债券P(0,5)替代常数利率），同时股票有稳定分红（对应q）、股票远期价格的波动率可估算为常数，满足公式的核心假设。
**公式**
$\text{股票看涨期权价值} = e^{-qT} S(0) N(d_1) - P(0,T) K N(d_2)$
$d_1 = \frac{\log\left(\frac{S(0)}{K P(0,T)}\right) - qT + \frac{1}{2}\sigma^2 T}{\sigma\sqrt{T}}, \quad d_2 = d_1 - \sigma\sqrt{T}$
**简化计算步骤**
(1) **收集基础参数**

* $S(0)$：当前股价（如：500 印度卢比 / 股）
* $K$：行权价（$500×120\%=600$卢比 / 股）
* $q$：股票股息率（如：20 卢比 / 股分红 → $q=20/500=4\%$）
* $T$：期权期限（如：5 年）
* $P(0,5)$：5 年期印度国债价格（如：80 卢比 / 100 面值 → $P(0,5)=0.8$）
* $\sigma$：股票远期价格波动率（如：25%）
  (2) **计算****&#x20;****、****&#x20;**
  $d_1 = \frac{\log\left(\frac{500}{600×0.8}\right) - 0.04×5 + \frac{1}{2}×0.25^2×5}{0.25×\sqrt{5}} ≈ \frac{\log(1.0417) - 0.2 + 0.15625}{0.559} ≈ 0.11$
  $d_2 = 0.11 - 0.25×\sqrt{5} ≈ -0.45$
  (3) **查正态分布表得****&#x20;****、****&#x20;**
  $N(0.11)≈0.5438$，$N(-0.45)≈0.3264$
  (4) **计算期权价值**
  $\text{价值} = e^{-0.04×5}×500×0.5438 - 0.8×600×0.3264 ≈ 218.72 - 156.67 = 62.05\text{卢比/股}$

  ## 延迟交换期权

  以远期为标的的看涨期权，可以看作在远期合约到期日用K美元（或者等价的，到期日与远期合约相同的K单位贴现债券）交换标的资产的交换期权。
  因此，这是一个交换期权，交换的发生日为期权到期日之后的某个固定日期。
  Margrabe可以很容易地推广到其他资产交换期权的定价上，只要期权到期日在交换发生日之前。考虑价格为$S_i$、红利支付率为常数$q_i$的两种资产，并假定价格满足

$$
\frac{dS_i}{S_i}=\mu_i dt+\sigma_i dB_i
$$

其中漂移项$\mu_i$、波动率$\sigma_i$和布朗运动的关系都可以是一般的随机过程。但要假定两种资产的价格比值的波动率

$$
\sigma = \sqrt{\sigma_1^2 + \sigma_2^2 - 2\rho\sigma_1\sigma_2}
$$

为常数。
考虑到期日为T、并在$T'$时($T' \geq T$)用第二种资产交换第一种资产的交换期权。
为理解期权在T时的价值，假设期权被执行。为了抵消两种资产的头寸，投资者可以卖出一份要收到的资产的远期合约，而买入一份要交付资产的远期合约，远期合约的到期日为资产交换发生日。则远期价格差$F_1(T)-F_2(T)$是在资产交换发生日$T'$将要得到/支出的现金流，该现金流在T时的价值为$P(T,T')[F_1(T)-F_2(T)]$。因此期权在到期日T的价值为

$$
\max(0,P(T,T')F_1(T)-P(T,T')F_2(T))
$$

这种方法不要求存在可交易的远期合约，远期合约可以用合成的方法得出。
又

$$
S_1^*(t)=P(t,T')F_1(t),\quad S_2^*(t)=P(t,T')F_2(t)
$$

是无红利支付的资产价格，因此在$T'$进行资产交换的期权，与在T时进行价格为$S^*_i$的两种资产交换的期权必定具有相同的价值。
远期价格的套利公式为（7.12）：

$$
F_i(t)=\frac{e^{-q_i(T'-t)}S_i(t)}{P(t,T')}
$$

因此

$$
S_i^*(t)=e^{-q_i(T'-t)}S_i(t)
$$

这说明比值$S_1^*/S_2^*$的波动率与比值$S_1/S_2$的波动率相同，因此可以用Margrabe公式对延迟交换期权进行定价，公式中的资产初始价格取为$S_i^*(0)=e^{-q_iT'}S_i(0)$，红利支付率为0.由此得出：

---

到期日为T、在$T'$时进行两种资产交换的欧式期权的价值为

$$
\boxed{e^{-q_1T'}S_1(0)N(d_1)-e^{-q_2T'}S_2(0)N(d_2)} \tag{7.17a}
$$

其中

$$
d_{1}=\frac{\log\left(\frac{S_{1}(0)}{S_{2}(0)}\right)+(q_{2}-q_{1})T'+\frac{1}{2}\sigma^{2}T}{\sigma\sqrt{T}} \tag{7.17b}
$$

$$
d_{2}=d_{1}-\sigma\sqrt{T} \tag{7.17c}
$$

---

## 程序实现

==每个期权价值都等于期权执行时所得价值的现值乘以N(x)，减去期权执行时所支付价值的现值乘以N(y)，x等于两个现值比的对数加上$\sigma^2T$的$\frac{1}{2}$，再除以$\sigma\sqrt{T}$。==
对于以远期合约为标的的期权，两个现值等于远期合约到期日所得到价值和所支付价值的现值。

```rust
pub fn Generic_Option(P1:f64,P2:f64,sigma:f64,T:f64)->f64{
    //输入参数
    //P1=将要得到的资产的现值
    //P2=将要支付的资产的现值
    //sigma=波动率
    //T=到期时间
    let x=((P1/P2).ln()+0.5*sigma.powi(2)*T)/(sigma*T.sqrt());
    let y=x-sigma*T.sqrt();
    let standard_norm=Normal::new(0.0,1.0).unwrap();
    //调用 standard_normal.cdf(x) 即可计算出 P (X ≤ x) 的值
    let n_d1=standard_norm.cdf(x);
    let n_d2=standard_norm.cdf(y);
    P1*n_d1-P2*n_d2
}

pub fn Margrabe(S1:f64,S2:f64,sigma:f64,q1:f64,q2:f64,T:f64)->f64{
    //输入参数
    //S1=将要得到的资产的价格
    //S2=将要支付的资产的价格
    //sigma=波动率
    //q1=将要得到的资产的红利支付率
    //q2=将要支付的资产的红利支付率
    //T=到期时间
    let margrabe_price=Generic_Option(S1*(-q1*T).exp(),S2*(-q2*T).exp(),sigma,T);
    margrabe_price
}

pub fn Black_Call(F:f64,K:f64,P:f64,sigma:f64,T:f64)->f64{
    //输入参数
    //F1=远期价格
    //K=执行价格
    //P=和远期合约同时到期的贴现债券价格
    //sigma=远期价格波动率
    //T=到期时间
    let Black_Call_Price=Generic_Option(F*P,K*P,sigma,T);
    Black_Call_Price
}

pub fn Black_Put(F:f64,K:f64,P:f64,sigma:f64,T:f64)->f64{
    //输入参数
    //F1=远期价格
    //K=执行价格
    //P=和远期合约同时到期的贴现债券价格
    //simga=远期价格波动率
    //T=到期时间
    let Black_Put_Price=Generic_Option(K*P,F*P,sigma,T);
    Black_Put_Price
}

pub fn Margrabe_Deferred(S1:f64,S2:f64,sigma:f64,q1:f64,q2:f64,Tm:f64,Te:f64)->f64{
    //输入参数
    //S1=将要得到的资产的价格
    //S2=将要支付的资产的价格
    //sigma=波动率
    //q1=将要得到的资产的红利支付率
    //q2=将要支付的资产的红利支付率
    //Tm=期权到期时间
    //Te=到交换发生的时间（大于等于Tm)
    let Margrabe_deferred=Generic_Option(S1*(-q1*Te).exp(),S2*(-q2*Te).exp(),sigma,Tm);
    Margrabe_deferred
}
```

## 希腊字母和对冲

能简化计算的关系式有：

$$
\boxed{e^{-q_1T}S_1(0)n(d_1)=e^{-q_2T}S_2(0)n(d_2)}
$$

取$q_1=q_2=0,S_1(0)=P(0,T')F(0)$和$S_2(0)=P(0,T')K$得出

$$
\boxed{F(0)n(d_1)=Kn(d_2)}
$$

看涨期权Black公式和Margrabe公式的希腊字母为：

| Black Call (Black 看涨期权公式)                                                      | Margrabe (Margrabe 交换期权公式)                                                                                                                                                                                                |
| :----------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| $\frac{\partial}{\partial F}=P(0,T')\,N(d_{1})$                                    | $\frac{\partial}{\partial S_{1}}=e^{-q_{1}T}\,N(d_{1})$                                                                                                                                                                       |
| $\frac{\partial}{\partial P}=F(0)\,N(d_{1})-K\,N(d_{2})$                           | $\frac{\partial}{\partial S_{2}}=-e^{-q_{2}T}\,N(d_{2})$                                                                                                                                                                      |
| $\frac{\partial^{2}}{\partial F^{2}}=\frac{P(0,T')\,n(d_{1})}{\sigma\sqrt{T}F(0)}$ | $\frac{\partial^{2}}{\partial S_{1}^{2}}=\frac{e^{-q_{1}T}\,n(d_{1})}{\sigma\sqrt{T}S_{1}(0)}$                                                                                                                                |
| $\frac{\partial^{2}}{\partial P^{2}}=0$                                            | $\frac{\partial^{2}}{\partial S_{2}^{2}}=\frac{e^{-q_{2}T}\,n(d_{2})}{\sigma\sqrt{T}S_{2}(0)}$                                                                                                                                |
| $\frac{\partial^{2}}{\partial F\partial P}=N(d_{1})$                               |                                                                                                                                                                                                                                 |
| $-\frac{\partial}{\partial T}=-\frac{\sigma P(0,T')F(0)\,n(d_{1})}{2\sqrt{T}}$     | $-\frac{\partial}{\partial T}=q_{1}e^{-q_{1}T}S_{1}(0)\,N(d_{1})$ `<br>` $\quad \quad \quad -q_{2}e^{-q_{2}T}S_{2}(0)\,N(d_{2})$ `<br>` $\quad \quad \quad -\,\frac{\sigma e^{-q_{1}T}S_{1}(0)\,n(d_{1})}{2\sqrt{T}}$ |
| $\frac{\partial}{\partial\sigma}=\sqrt{T}P(0,T')F(0)\,n(d_{1})$                    | $\frac{\partial}{\partial\sigma}=\sqrt{T}e^{-q_{1}T}S_{1}(0)\,n(d_{1})$                                                                                                                                                       |

Margrabe公式的对冲和Black公式的对冲大同小异。用持有$\delta_1=e^{-q_{1}T}\,N(d_{1})$单位的第一种资产和$\delta_2=e^{-q_{2}T}\,N(d_{2})$单位的第二种资产（即卖空第二种资产）对卖出的交换期权进行德尔塔对冲。
注意，卖出期权所得刚好为对冲提供资金，因此整个投资组合的成本为0.如果连续不断地对投资组合进行调整，则这个0成本投资组合的收益也为0。
Black公式是Margrabe公式的特例，可以按照同样的方法对远期合约为标的的期权进行德尔塔对冲。令$q_1=q_2=0,S_1(0)=P(0,T')F(0)$和$S_2(0)=P(0,T')K$，用买入$N(d_1)$单位的第一种资产、卖出$N(d_2)$单位的第二种资产的方法可以对卖出的看涨期权进行德尔塔对冲，其中的$d_1$和$d_2$由Margrabe公式中(7.4b)和(7.4c)定义，并等价于Black公式中(7.6b)和(7.6c)给出的定义。这里，第一种资产由一份远期合约多头和F(0)单位贴现债券构成，第二种资产由K单位贴现债券构成。因此，应该买入$N(d_1)F(0)-N(d_2)K$单位的贴现债券并持有$N(d_1)$单位的远期合约多头头寸。

## 远期价格和期货价格的关系

远期合约和期货合约的区别在于，期货是逐日盯市的，即每日的收益和损失都在投资者的保证金账户中进行结算，因此期货具有期间现金流，而远期合约只有在到期日才有现金流发生。
三个十分重要的结论：

+ 在风险中性测度下，期货价格是一个鞅
+ 当采用与远期合约具有相同到期日的贴现债券作为计价物时，远期价格是一个鞅。
+ 利率为非随机时，期货价格等于远期价格
  最后一个结论可以由前两个结论得出。

### 在风险中性测度下，期货价格是一个鞅

假设存在瞬时无风险资产，其收益率r随着时间的推移而随机变化，定义

$$
R(t)=\exp(\int^t_0 r(s)ds)
$$

令$T'$表示期货合约到期日，$F^*(t)$表示$t(t\leq T')$时的期货价格（用*将期货价格与远期价格区分开）。
考虑一个投资组合，开始时由0美元和一份价格为$F^*(0)$的期货合约多头组成，连续不断地将期货合约的盈利投资于无风险资产，而期货合约的损失则通过撤出无风险投资来弥补。
用$V(t)$表示该投资组合在t时的价值，投资组合价值的瞬时改变量为无风险资产的利息收入（当V<0时为支出）加上期货合约上的盈利/损失。由此得出

$$
dV=rVdt+dF^*
$$

由于投资者的所有盈利和损失都进行了再投资，V是无红利支付的资产价格。由此在风险中性测度下（以R为计价物），比值V/R必定是一个鞅。因此漂移为0。由Ito公式知

$$
\begin{aligned}
\frac{d(V/R)}{V/R}&=\frac{dV}{V}-\frac{dR}{R}\\
&=\frac{rVdt+dF^*}{V}-rdt\\
&=\frac{dF^*}{V}
\end{aligned}
$$

因此，V/R的漂移项为0意味着$F^*$的漂移项为0。
这里需要假设（并且可以假设）$F^*$是一个Ito过程，期望二阶变差有限，在这种情况下，漂移项为0意味着是一个鞅。

### 当采用与远期合约具有相同到期日的贴现债券作为计价物时，远期价格是一个鞅

考虑到期日为$T'$的一份远期合约和到期日也是$T'$的一单位贴现债券。用$F(t)$表示远期价格，$P(t,T')$表示$t(t \leq T')$时的贴现债券价格。存在价格为$P(t,T')F(t)$的无红利支付资产，以贴现债券为计价物时，比值$P(t,T')F(t)/P(t,T')=F(t)$为鞅，所以结论成立。
把贴现债券为计价物时对应的概率测度称为 ==“远期测度”== 。

+ 期货价格：以 “货币市场账户（即之前的\(R(t)\)，连续复利的无风险资产）” 为计价单位（对应风险中性测度），期货价格是鞅；
+ 远期价格：以 “同期限贴现债券” 为计价单位（对应远期测度），远期价格是鞅；
  两者的差异源于计价单位（测度）的选择，而这又对应了期货 “逐日盯市”、远期 “到期现金流” 的合约差异。

### 利率为非随机时，期货价格等于远期价格

核心逻辑是“利率确定时，期货/远期对应的两种概率测度重合，进而通过鞅性质推出价格相等”。结合前面的内容，拆解如下：

1. 前提：利率是“确定性的”
   这里的“利率确定性”是指：即使利率

   $$
   r(t)
   $$

   随时间变化，它也是非随机的（可预测的）。此时，到期日为

   $$
   T'
   $$

   的贴现债券，在0时刻的价格就是确定的贴现因子：

$$
P(0,T') = \exp\left( -\int_0^{T'} r(t)dt \right)
$$

（这是连续复利下的贴现债券定价：因为利率确定，贴现因子是唯一、确定的）
2. 关键：两种测度（计价单位对应的概率）重合
之前的内容提到：

- 期货价格对应风险中性测度（以“货币市场账户$R(t)$”为计价单位）；
- 远期价格对应远期测度（以“同期限贴现债券$P(t,T')$”为计价单位）。
  这里通过“状态价格$\phi$”（用于表示不同状态下的资产价值权重），证明：当利率确定时，这两种测度是同一个测度。
  （1）远期测度下的事件概率（以贴现债券为计价单位）
  事件$A$在远期测度下的概率为：

$$
\text{prob}^P[A] = E\left[ 1_A \phi(T') \frac{P(T',T')}{P(0,T')} \right]
$$

- $1_A$是“事件$A$发生”的指示函数（发生为1，否则为0）；
- $\phi(T')$是到期日$T'$的状态价格；
- $P(T',T') = 1$（贴现债券到期时的价格=面值，通常为1）。
  代入$P(0,T') = \exp\left( -\int_0^{T'} r(t)dt \right)$，化简得：

$$
\text{prob}^P[A] = \exp\left( -\int_0^{T'} r(t)dt \right) E\left[ 1_A \phi(T') \right]
$$

（2）风险中性测度下的事件概率（以货币市场账户为计价单位）
事件$A$在风险中性测度下的概率为：

$$
\text{prob}^R[A] = E\left[ 1_A \phi(T') \frac{R(T')}{R(0)} \right]
$$

- $R(t)$是货币市场账户（0时刻投资1元、连续复利的无风险资产），故$R(0)=1$，$R(T') = \exp\left( \int_0^{T'} r(t)dt \right)$（利率确定，故$R(T')$是确定值）。
  代入后化简得：

$$
\text{prob}^R[A] = \exp\left( -\int_0^{T'} r(t)dt \right) E\left[ 1_A \phi(T') \right]
$$

（3）结论：两种测度重合
对比两个概率公式，发现$\text{prob}^P[A] = \text{prob}^R[A]$，即：
当利率确定时，远期测度（对应远期）和风险中性测度（对应期货）是同一个测度，对应的期望运算$E^P$（远期测度下的期望）和$E^R$（风险中性测度下的期望）相等。
3. 结合鞅性质，推出“期货价格=远期价格”
利用之前的鞅性质+到期价格的共性：

- 期货价格$F^*(t)$是风险中性测度下的鞅：$F^*(t) = E_t^R\left[ F^*(T') \right]$；
- 远期价格$F(t)$是远期测度下的鞅：$F(t) = E_t^P\left[ F(T') \right]$；
- 到期时，期货/远期价格都等于标的资产的即期价格：$F^*(T') = F(T') = S(T')$（因为到期时“远期/期货合约”都等价于直接以即期价格交易标的）。
  由于$E^P = E^R$，因此：

$$
F^*(t) = E_t^R\left[ F^*(T') \right] = E_t^P\left[ F(T') \right] = F(t)
$$

这就证明了“事实(3)”：当利率非随机时，期货价格与远期价格相等。

## 期货期权

虽然在利率不随机的假设下，期货价格等于具有相同期限的远期价格，但以期货合约为标的的期权价值并不等于以对应的远期合约为标的的期权价值。
	这种价值的差别来自于盯市制度。
	设期货和远期合约的到期日为$T'$，期权的到期日为$T$，$T\leq T'$。

执行一份以期货合约为标的的看涨期权，使投资者拥有一个期货合约多头，期货价格等于当日的期货价格。市场期货价格和期权执行价格的差额$F^*(T)-K$将**立即结算**并进入投资者的保证金账户。

另一方面，执行一份以远期合约为标的的期权并卖出远期合约将产生一个现金流$F(T)-K$，而这个现金流在远期合约到期日$T'$才能得到。

因此：
以期货合约为标的的看涨期权在其到期日的价值为$\max(0,F^*(T)-K)$
以远期合约为标的的看涨期权在其到期日的价值为$P(T,T')\max(0,F(T)-K)$

与以远期合约为标的的期权一样，以期货合约为标的的期权可以看做一个交换期权，投资者在时间$t(t\leq T')$用价格为$S_2=P(t,T)K$的资产来交换价格为$S_1(t)=P(t,T)F^*(t)$的资产。
显然价格为$S_2$的资产是K单位到期日为T的贴现债券。
假设利率是确定性的，则有$F^*(t)=F(t)$，又$P(t,T)F(t)$是无红利支付的资产价格。因此在确定性利率的假设下，可以用Margrabe公式对以期货为标的的看涨（和看跌）期权进行定价。
以期货合约为标的的期权和以远期合约为标的的期权的差别，在于用来定义资产价格$S_1$和$S_2$的贴现债券的到期日是期权的到期日，而不是期货合约或远期合约的到期日。
由此得出Black公式：

---

假设利率是确定性的，期货价格$F^*$的波动率$\sigma$为常数，则以期货合约为标的欧式看涨期权和看跌期权的价值为

$$
\boxed{\text{看涨期权价格}=P(0,T)F^*(0)N(d_1)-P(0,T)KN(d_2)}\tag{7.18a}
$$

$$
\boxed{\text{看跌期权价格}=P(0,T)KN(-d_2)-P(0,T)F^*(0)N(-d_1)}\tag{7.18b}
$$

其中

$$
d_1=\frac{\log(\frac{F^*(0)}{K})+\frac{1}{2}\sigma^2T}{\sigma\sqrt{T}} \tag{7.18c}
$$

$$
d_2=d_1-\sigma\sqrt{T} \tag{7.18d}
$$

---

## 时变波动率

本章所有期权定价公式都是从Margrabe公式中推导出的，用到的主要假设是T时的资产价格比值的对数服从$\sigma^2T$的正态分布。
本章的公式也可以很容易地推广到时变但非随机波动率的情形。
如果波动率是时间的非随机函数$\sigma(t)$，则定义$\sigma_{avg}$为

$$
\sigma_{avg}^2=\frac{1}{T}\int^T_0\sigma^2(t)dt \tag{7.19}
$$

$\sigma_{avg}$可以作为如下两种情形下的输入参数：
（1）如果$\sigma(t)$为资产价格比值t时的波动率，则$\sigma_{avg}$可以作为Margrabe公式和延迟交换期权公式中的波动率输入参数；
（2）如果$\sigma(t)$为远期价格t时的波动率，则$\sigma_{avg}$可以作为Black公式和Merton公式中的远期价格的波动率输入参数。

## 用远期和期货进行对冲

考虑时间$t<u$和到期日为T的远期合约。
假设在时间t买入x(t)的远期后，在时间u将远期头寸改变为x(u)，相当于先卖出x(t)份平仓，再买入x(u)份，且在T时结算。买入/卖出$x(u)-x(t)$份新合约不影响投资组合的价值，因此投资组合价值的改变量等于t时购买的合约x(t)在u时价值的改变量。由于远期合约的初始价值为0，这些合约在t时的价值为0.在u时卖出这些合约将抵消标的资产的交付/接收义务，留给投资者的只有在T时得到现金流$x(t)[F(u)-F(t)]$美元，现金流在u时的价值为$x(t)P(u,T)[F(u)-F(t)]$。
上述分析用式子表达为：

$$
\begin{aligned}
&x(t)P(u,T)[F(u)-F(t)]\\
=& x(t)\{P(t,T)[F(u)-F(t)]+[P(u,T)-P(t,T)][F(u)-F(t)]\} \\
=& x(t)\{ P(t,T)\Delta  F +(\Delta P)(\Delta F) \}
\end{aligned}
$$

受此启发，给出如下定义：

---

远期合约形成的投资组合在t时的价值改变量为

$$
x(t)[P(t,T)dF(t)+dP(t,T)\times dF(t)]
$$

---

用期货进行对冲要简单一些，因为盈利和损失是随时（至少是每日）结算的，不需要推迟到合约到期日。用x(t)表示t时持有的期货合约份数，$F^*(t)$为期货价格，期货合约发生的现金流为$x(t)dF^*(t)$，这也是投资组合的价值改变量，因为盯市制度使期货合约的价值总是等于0.

下面对期货对冲与远期对冲进行比较。
设存在常数无风险利率r。用T表示期货和远期合约的到期日。由于存在不变的无风险利率，$P(t,T)=e^{-r(T-t)}$，这意味着$(dP)(dF)=0$（$dP(t,T)=rP(t,T)dt$,而dF里有dt和dB,故为0）。此外，期货价格等于远期价格，因此，

---

如果存在不变的无风险利率r，则由远期合约形成的投资组合在t时的价值改变量为

$$
x(t)e^{-r(T-t)}dF(t) \tag{7.21}
$$

期货合约形成的投资组合在t时的价值改变量为

$$
x(t)dF(t) \tag{7.22}
$$

其中x(t)表示t时持有的期货/远期合约份数，T为期货和远期合约的到期日，F(t)为t时的期货价格（=远期价格）。

---

比较(7.21)和(7.22)可以看出，如果x(t)为对冲所需要持有的远期合约数，则

$$
y(t)=e^{-r(T-t)}x(t) \tag{7.23}
$$

为对冲所需要持有的期货合约份数。
对冲并不需要和远期合约一样多的期货合约，将远期合约折合为期货合约的倍数因子恰好时现值因子$e^{-r(T-t)}$。
以用远期合约来复制回报函数$\bar{X}S(T)$的结论可以得出如下结论：

---

设$\bar{X}$表示固定汇率，S表示以外币计价的资产价格。要复制回报函数$\bar{X}S(T)$，需要在t时将V(t)单位的本币投资于外国资产，同时持有$e^{(r_f-r)(T-t)}V(t)/X(t)$的货币期货空头，其中V(t)由(6.7)定义，X(t)为即期汇率。

---

设利率为非随机的，期货期权比远期合约为标的的期权由更高的价值。
当无风险利率为常数，期权到期日为T，期货/远期到期日为$T'$时，两种期权的价值具有以下关系：

$$
\text{期货期权价值}=e^{r(T'-T)}\text{远期期权价值}
$$

因为因子$e^{r(T'-T)}$不随时间变化，上面的关系意味着当时间变化时有

$$
\text{期货期权价值改变量}=e^{r(T'-T)}\text{远期期权价值改变量}  \tag{7.24}
$$

用$N(d_1)$份远期合约多头对冲以远期合约为标的的看涨期权空头，由(7.23)，可以用$e^{-r(T'-t)}N(d_1)$的期货合约多头对冲以远期合约为标的的看涨期权空头。由(7.24)，要对冲以期货合约为标的的看涨期权空头，需要持有

$$
e^{r(T'-T)}e^{-r(T'-t)}N(d_1)=e^{-r(T-t)}N(d_1)
$$

的期货合约多头。

## 市场完备性

严格的市场完备性定义必须能够说明，哪些状态以来的或有权益（依赖历史价格的随机变量）能够通过市场化资产的交易进行复制。
随机波动模型是不完备模型。
一般来说，一个市场必须包含一个瞬间无风险资产和与布朗运动同样多的风险资产才能称为完备市场。
Margrabe交换期权模型中由两种风险资产，两个布朗运动。没有无风险资产，显然是不完备模型。例如，在时间T，投资者恰好拥有$100是不可能的。没有无风险资产，就没有办法存钱。
当考虑的回报函数是“真实”（即通货膨胀调整的）美元支付时，不存在无风险资产就是一种正常现象。

> 要理解这句话，核心是 “真实美元（通胀调整后）” 的 “无风险” 定义变了：
> 在名义美元里，“无风险资产” 是 “未来能确定拿到固定金额” 的资产（比如无风险债券，到期肯定给你 100 美元）。
> 但在真实美元（通胀调整后）里，“无风险” 的要求是 “未来能确定拿到固定的购买力”—— 而通胀是随机波动的（未来物价水平不确定），所以 “名义上固定的金额” 对应的 “真实购买力” 是不确定的。
> 比如：现在买无风险债券，到期拿 100 美元（名义），但未来通胀率可能是 3% 也可能是 8%，这 100 美元能买的商品数量（真实购买力）是随机的。此时，“名义无风险资产” 在 “真实美元” 维度下，变成了 “有风险资产”——不存在能保证 “确定真实购买力” 的资产。
> 因此，在 “真实美元（通胀调整）” 的支付场景中，“没有无风险资产” 是正常的（因为通胀的随机性让 “真实无风险” 的资产根本不存在）。

一个完备市场的严格定义必须能够说明哪些或有权益可以被复制。
要理解“Margrabe模型对特定或有权益完备”，得先锚定**“市场完备性”的核心：或有权益能否被资产组合复制**，再结合Margrabe的设定拆解：

### 第一步：先明确几个基础概念

- **或有权益**：到期时的“随机收益”（比如期权到期拿 `max(S₁(T)-S₂(T),0)`，或者到期拿固定100美元）。
- **市场对某或有权益“完备”**：能用已有的资产（Margrabe里是S₁、S₂两种风险资产）构建一个组合，让这个组合的到期收益**完全等于**该或有权益的收益（即“复制”）。

### 第二步：Margrabe模型的“全局不完备”

Margrabe的设定是：**2种风险资产（S₁、S₂）+2个布朗运动（随机波动源），但没有无风险资产**。
全局来看，它是“不完备”的——比如“到期确定拿100美元”这个或有权益，就没法复制：
因为没有无风险资产（没法存固定金额的资金），而S₁、S₂都是风险资产（价格随机），任何S₁、S₂的组合到期价值都是随机的，不可能“确定等于100美元”。

### 第三步：Margrabe对“特定或有权益”的完备性

Margrabe的“特定或有权益”，是指**收益形式为“S₁(T)×X(T)”或“S₂(T)×X(T)”的或有权益**（其中X(T)是“只依赖相对价格S₁(t)/S₂(t)”的随机变量）。
交换期权的收益（`max(S₁(T)-S₂(T),0)`）刚好是这种形式：
`max(S₁(T)-S₂(T),0) = S₂(T)×max( S₁(T)/S₂(T) - 1, 0 )`
这里 `X(T)=max( S₁(T)/S₂(T) - 1, 0 )`，完全依赖相对价格 `S₁/S₂`。

### 为什么这类收益能被复制？（核心：计价单位变换）

Margrabe模型里**没有全局无风险资产，但可以把“其中一种风险资产当作计价单位”**——比如把S₂当作“计价单位”（相当于用S₂的份数来衡量所有资产的价值）：

- 此时S₂自身的价值（用S₂当计价单位）是“1份S₂”，相当于“相对的无风险资产”（因为它的价值不再波动，固定为1）；
- 而S₁的价值（用S₂当计价单位）是 `S₁(t)/S₂(t)`，这个比值的波动只对应**1个布朗运动**（因为S₁、S₂各自的布朗运动组合后，只有1个独立波动源）。
  这时候，交换期权的收益（`S₂(T)×max(S₁/S₂ -1, 0)`），以S₂为计价单位看，就变成了 `max(S₁/S₂ -1, 0)`——这和Black-Scholes模型里“以无风险资产为计价单位的欧洲期权收益”完全一致（单风险源、可复制）。
  因此，我们可以用S₁和S₂构建组合，先复制出 `max(S₁/S₂ -1, 0)`，再乘以S₂(T)，就能完全复制交换期权的收益——这就实现了“对这类特定或有权益的完备性”。
  简单说：Margrabe模型没法复制“任意或有权益”，但对“收益绑定其中一种资产价格、且依赖两者相对价格”的或有权益（比如交换期权本身），可以通过“把其中一种资产当计价单位”转化为可复制的形式，所以对这类收益是完备的。
