[toc]

# 资产定价基本概念

## 单期二叉树模型中的状态价格

假定
$$
\frac{S_u}{S}>e^{rT}>\frac{S_d}{S} \tag{1.1}
$$
以上为无套利条件。

看涨期权的$\Delta$定义为：$\delta=(C_u-C_d)/(S_u-S_d)$
$$
\begin{align}
\delta&=(C_u-C_d)/(S_u-S_d)\\
&\Rightarrow \delta S_u-C_u=\delta S_d -C_d\\
&\text{ 考虑一个在时间0买入}\delta\text{份股票的投资组合，借入美元现金为：}\\
&\Rightarrow e^{-rT}(\delta S_u-C_u)=e^{-rT}(\delta S_d -C_d) \\
&\text{投资者在时间T欠的美元现金为}\\
&\Rightarrow \delta S_u-C_u=\delta S_d -C_d\\
\end{align}
$$
时间T，上升状态下投资组合的价值为：
$$
\delta\text{份股票的价值-所欠美金}=\delta S_u-(\delta S_u-C_u)=C_u
$$
下降状态下，投资组合的价值为：
$$
\delta\text{份股票的价值-所欠美金}=\delta S_d-(\delta S_d-C_d)=C_d
$$
由此看出，购买$\delta$份股票和借入现金（即采用保证金购买方式购买股票）形成的投资组合**复制**了看涨期权，因此时间0时的期权价值C必定与时间0时的投资组合成本相等，即
$$
C=\delta\text{份股票的成本-所借美金}=\delta S - e^{-rT}(\delta S_u -C_u) \tag{1.2}
$$
由于看涨期权与以保证金购买方式买入股票等价，因此可以看作在股票上的**杠杆投资**



将期权定价公式（1.2）用**”状态价格“**表示。将（1.2）中的$\delta$进行替换并整理，可以得出：
$$
C=\frac{S-e^{-rT}S_d}{S_u-S_d}\times C_u + \frac{e^{-rT}S_u-S}{S_u-S_d} \times C_d \tag{1.3a}
$$
同样简单代数运算得出：
$$
S=\frac{S-e^{-rT}S_d}{S_u-S_d}\times S_u + \frac{e^{-rT}S_u-S}{S_u-S_d} \times S_d \tag{1.3b}
$$
和
$$
1=\frac{S-e^{-rT}S_d}{S_u-S_d}\times e^{rT} + \frac{e^{-rT}S_u-S}{S_u-S_d} \times e^{rT} \tag{1.3c}
$$
用另一种符号表示上式中的两个因子：
$$
\pi_u=\frac{S-e^{-rT}S_d}{S_u-S_d},\pi_d=\frac{e^{-rT}S_u-S}{S_u-S_d} \tag{1.4}
$$
$\pi_u$和$\pi_d$称为==”状态价格“==，反映了市场在初始时刻对”上涨状态或下跌状态发生时获得1单位支付“的定价。

用（1.4）定义的符号改写（1.3a）—（1.3c）：
$$
C=\pi_u C_u + \pi_d C_d \tag{1.5a}
$$

$$
S=\pi_u S_u + \pi_d S_d \tag{1.5b}
$$

$$
1=\pi_u e^{rT}+\pi_d e^{rT} \tag{1.5c}
$$

上面三式可以解释为：今日的证券价格等于上升状态的价值乘以$\pi_u$加上下降状态的价值乘以$\pi_d$

(1.5b)可以理解为：股票等价于由$S_u$份第一类阿罗证券和$S_d$份第二类阿罗证券构成的投资组合。

==状态价格$\pi(\omega)$指：为了在状态$\omega$发生时获得$1的收益，现在需要支付的价格。它已经包含了概率和风险偏好的综合权重，是一个经风险调整过的概率权重。其将”这件事发生的可能性“和”这件事发生的好坏“两个因素打包成了一个单一权重。==

这个价格 $\pi(\omega)$ 并不是凭空产生的，它是市场根据以下两个核心因素决定的：
1. 状态$\omega$发生的可能性（概率$ P(\omega)$）：一个几乎不可能发生的状态，它的状态价格自然会非常低。
2. 市场对状态 $\omega$ 所承载风险的态度（风险厌恶 / 偏好）：如果状态 $$\omega$$ 是一个大家都讨厌的 “坏状态”（比如经济危机），那么为了在这种情况下能拿到 1 元钱，人们可能愿意支付更高的价格（就像购买保险一样）。



> 一个通俗的例子：
> 火灾保险假设你的房子价值 100 万元。有两种可能的未来状态：
>
> $\omega$：房子失火，价值变为 0。
>
> $\omega_2$：房子安全，价值仍为 100 万。
>
> 真实概率：假设失火的概率 $P(\omega_1) = 0.01 $(1%)，安全的概率 $P(\omega_2) = 0.99 (99%)。现在，你想为房子买一份保险，保障在失火时能获得 100 万元的赔偿。保险公司会怎么定价这份保险？如果只看概率：保险公司预期的赔付金额是 $0.01 $\times$ 100万 + 0.99 $\times 0 = 1万$ 元。但实际保费会更高：因为保险公司需要盈利，并且要覆盖运营成本和承担风险。
>
> 假设保险公司向你收取 1.2 万元 的保费。这里的 1.2 万元保费，就可以看作是状态 $\omega$（失火）发生时，获得 100 万元收益的状态价格。我们可以把它归一化到获得 1 元收益的情况：$\pi(\omega_1) = \frac{1.2万}{100万} = 0.012$这个 $\pi(\omega_1) = 0.012$ 就是 “失火” 这个状态的状态价格。它不等于真实概率 $P(\omega_1) = 0.01$，而是比它高，这高出的部分就体现了风险溢价。对于 “安全” 这个状态 $\omega_2$，因为它不会给你带来额外的收益（你的房子本来就安全），所以它的状态价格 $\pi(\omega_2) = 0$。
>
> ​	现在，我们用状态价格公式来计算你为了获得 “房子失火时得到 100 万” 这个权益，需要支付的总价格（也就是保费）：$\text{保费} = \pi(\omega_1) \times 100万 + \pi(\omega_2) \times 0 = 0.012 \times 100万 = 1.2万 \text{元}$这个结果与我们的直觉完全相符！公式完美地工作了，而且它没有，也不需要再乘以一个概率 $P(\omega)$，因为 $\pi(\omega)$ 已经包含了概率的信息，并且做了风险调整。

条件$\pi_u>0$和$\pi_d>0$完全等价于”无套利“假设（1.1），因此得出结论：

> 当不存在套利机会时，存在正的价格状态，使得任何证券的价格都可以表示为各种状态下的回报乘以状态价格然后求和。

## 概率与计价物

将上升状态和下降状态的风险中性概率分别定义为$\pi_u e^{rT}$和$\pi_d e^{rT}$，并分别用$p_u$和$p_d$表示。采用这些符号重写（1.5a）—（1.5c）：
$$
C=e^{-rT}[p_uC_u+p_dC_d] \tag{1.6a}
$$

$$
S=e^{-rT}[p_uS_u+p_dS_d] \tag{1.6b}
$$

$$
1=p_u+p_d \tag{1.6c}
$$

(1.6a)和(1.6b)表明，今日的证券价格等于T时股票价格（关于风险中性概率的）的数学期望以无风险利率贴现的现值。这些公式都是”现值”公式，但与资本资产定价模型不同，贴现率中不包含风险溢价。即在对资产进行定价时，可以对概率进行调整，使投资者像是风险中性一样。当然，这里并没有真正将投资者假定为风险中性，而是将风险溢价体现在概率的调整上。

相关术语：

+ 概率测度：时间的概率，简称测度。
+ 计价物：一种资产的价格与另一种资产的价格之比，是以第二种（分母）资产为计价物的第一种（分子）资产的价值。
+ 鞅：随时间变化的随机变量，如果其未来的期望值总等于当前值。

==**如果不存在套利机会，对应每一项（不支付红利的）资产，都存在一个概率测度，使得任何其他（不支付红利的）资产的价格与该资产（计价物）的价格之比是一个鞅**。==

以上结论提供了计算衍生证券价值足够的概率信息，不需要计算具体的概率值。

### 连续状态的资产定价

本节定义不同计价物下状态价格和概率的概念，展示的是金融衍生品定价理论中的一个核心内容——“基本定价方程”的数学构建过程。它用严谨的数学语言将直观的“状态价格”概念一般化，是理解现代金融定价理论的基石。

本小节的梳理逻辑：

目标：给一个不确定的未来收益（如期权）定价。

原理：无套利原则要求必须存在一套“公平”的定价体系。

初始工具：我们找到了“状态价格密度” φ(T)这把万能尺子，可以直接度量未来价值在今天的价格（公式1.10）。

巧妙简化：我们发现，与其费力地直接使用这把尺子，不如换一个“宇宙”（即概率测度）来生活。在这个新宇宙里，所有人的风险偏好都是中性的，都只要求无风险收益。原来那把复杂的尺子 φ(T)在新宇宙的规则下消失了。

最终方程：在新宇宙里，定价变得极其简单：任何资产的今天价格，就等于其未来价格在新概率下的期望值，再用无风险利率折现回来。这就是衍生品定价的终极形式——“基本定价方程”的精髓。

本小节正是从原始的、直接的状态价格概念（公式1.10）出发，通过引入计价物和概率测度变换（公式1.11, 1.12），为得出最终简洁实用的定价公式铺平了道路。这是连续时间金融理论中连接直觉与数学的关键桥梁。



考虑无红利支付证券，T时的证券价格为随机变量$S(T)$。各种可能出现的、影响价格S(T)的状况称为==“状态”==。上一节的状态价格原理可以表述为更一般的形式：

> 如果不存在套利机会，则对每个时间T，都存在正的随机变量$\phi(T)$，使得无红利支付证券在时间0的价值为
> $$
> S(0)=\mathbb{E}[\phi(T)S(T)] \tag{1.10}
> $$

其中随机变量$\phi(T)$称为==“状态价格密度”==。可以把 φ(T)理解为一个“价值折算因子”，但它不是固定的，而是依赖于未来不同的“状态”（比如经济繁荣、衰退等）。（1.10）这个公式的意思是：今天的公平价格，等于未来各种可能价格经过“状态价值”调整后的平均期望值。φ(T)负责将未来不同状态下的钱，折算成今天同等价值。

在一个离散的世界里，资产的当前价格就是未来所有可能状态下的收益乘以对应状态的状态价格，然后求和，即$S(0)=\sum_\omega \pi(\omega)\cdot S(\omega)$，即把各种情况下的收益都换算成今天的钱，然后加起来。

在现实世界中我们更习惯使用概率来思考问题：$S(0)=\sum_\omega(\frac{\pi(\omega)}{p(\omega)})\cdot S(\omega)\cdot p(t)=\mathbb{E}[\phi(T)S(T)]$

但是，直接使用$\phi(T)计算有时很麻烦，所以通过巧妙地调整概率的权重，将$$\phi(T)$吸收到新的概率定义中，从而简化计算。

以S为计价物时事件A的概率定义为：
$$
\text{prob}^S(A)=\mathbb{E}[1_A \phi(T)\frac{S(T)}{S(0)}] \tag{1.11}
$$
以S为计价物时随机变量X的数学期望是
$$
\mathbb{E}^{Q_S}[X]=\mathbb{E}[X \phi(T)\frac{S(T)}{S(0)}] \tag{1.12}
$$
公式（1.12）的核心目的是定义一个全新的数学期望$ E^{Q_S}[\cdot]$。$E[\cdot]$是在我们熟悉的、基于历史数据和真实风险偏好的现实世界概率测度下的期望。$E^{Q_S}[ \cdot ]$是在一个人造的、以资产S为计价物的概率测度 $Q_S$下的期望。这个新测度是为了定价方便而构造的。

公式（1.12）就是连接这两个世界的桥梁。它明确规定：“在你这个以S为计价物的新世界$ Q_S$里，计算一个变量X的期望值，等价于在我们原来的真实世界里计算 φ(T) * [S(T)/S(0)] * X的期望值。”

> 转换前：资产价格 = 在“真实世界”的概率下，计算【未来价格 × 状态价格】的平均值。
>
> $\longrightarrow$公式复杂，因为包含了难以捉摸的 φ(T)。
>
> 转换后：资产价格 = 在“以S为计价物的世界”的概率下，计算【资产与计价物的相对价格 (V/S)】的平均值，然后再用计价物的当前价格 (S(0)) 放大回来。
>
> $\longrightarrow$公式简洁，φ(T)神奇地消失了，被吸收到了新概率 Q_S的定义中。
>
> 一个简单的比喻：
>
> 想象用一把刻度不均匀的“状态价格尺”φ(T)去测量物品V的价值，很麻烦。
>
> “概率转换”相当于我们换了一把刻度均匀的新尺子（新概率测度 Q_S），这把新尺子是以一个参照物 S为标准刻度的。
>
> 在新尺子下，我们只需要测量物品V相对于参照物S的价值（即 V/S），然后用参照物本身的价格 S(0)一乘，就得到了物品 V的绝对价格。
>
> 最重要的特例：风险中性测度
>
> 当选择的计价物 S是无风险资产（比如银行存款）时，即 S(t) = e^{rt}，这个新概率测度就称为风险中性测度。在这个测度下，所有资产的预期收益率都等于无风险利率 r，这使得衍生品定价变得非常方便。你所熟知的布莱克-斯科尔斯期权定价公式，就是在这个框架下推导出来的。

### 基本定价公式

$$
Y(t)=S(t)\mathbb{E}^S_t[\frac{Y(T)}{S(T)}] \tag{1.17}
$$

此公式为==基本定价公式==，是现代衍生证券定价的核心。

它是一个现值关系：资产在时间t的价值是其在T时的价值以$S(t)/S(T)$为折现因子（可以是随机的）折现后的数学期望。

为了表明计价物可以是任何无红利支付的资产（而不是必须为S表示的股票价格），将（1.17）写成另一种等价的形式：
$$
Y(t)=num(t)\mathbb{E}^{\text{num}}_t[\frac{Y(T)}{\text{num(T)}}] \tag{1.17'}
$$

设$R(t)$表示无风险资产价格$e^{rt}$，并以此作为计价物，等式（1.17）为
$$
Y(t)=e^{rt}\mathbb{E}^R_t[\frac{Y(T)}{e^{rT}}]=e^{-r(T-t)}\mathbb{E}^R_t[Y(T)] \tag{1.18}
$$


## 期权定价入门

将复杂的回报分解为简单合约的方法，是对各种衍生品进行分析的关键所在。

### 股份数字合约的定价

$$
Y(T)=\begin{cases}
S(T) \quad \text{if }S(T)>K\\ 0 \quad \text{ else}
\end{cases}
$$

$$
\begin{align}
\mathbb{E}^{\text{num}}[\frac{Y(T)}{\text{num(T)}}]&=\mathbb{E}^{\text{num}}[\frac{Y(T)}{\text{num(T)}}|S(T) \geq K]\cdot \text{prob}^S(S(T)\geq K)\\
&+\mathbb{E}^{\text{num}}[\frac{Y(T)}{\text{num(T)}}|S(T) < K]\cdot \text{prob}^S(S(T)< K)\\
&=\mathbb{E}^{\text{num}}[1|S(T) \geq K]\cdot \text{prob}^S(S(T)\geq K)\\
&=\text{prob}^S(S(T)\geq K)
\end{align}
$$

这说明股份数字合约的价值为
$$
S(0)\times\text{prob}^S(S(T)\geq K)
$$

### 数字合约定价

$$
Y(T)=\begin{cases}
1 \quad \text{if }S(T)>K\\ 0 \quad \text{ else}
\end{cases}
$$

需要计算的$Y(0)$为：
$$
Y(0)=num(0)\mathbb{E}^{\text{num}}[\frac{Y(T)}{num(T)}]
$$
选择无风险资产R(t)作为计价单位，则
$$
Y(T)=K \cdot 1_{S_T \geq K}\\
num(t)=R(t)=e^{rt}\\
num(0)=1\\
num(T)=e^{rT}
$$

$$
\begin{align}
Y(0)&=num(0)\cdot\mathbb{E}^R[\frac{Y(T)}{num(T)}]\\
&=1\cdot \mathbb{E}^R[\frac{K \cdot 1_{S_T \geq K}}{e^{rT}}]\\
&=e^{-rT}\cdot K\cdot \mathbb{E}^R[1_{S_T \geq K}]\\
&=e^{-rT}\cdot K\cdot \text{prob}^R[S(T)\geq K]
\end{align}
$$

计价物转换只不过是一种“计算技巧”。从根本上说，这种方法之所以可行是因为定价是线性的。这种线性性表现在，一个现金流的价值等于不同状态下的现金流与状态价格相乘后求和。计价物变换正是采用了线性性来简化有关的定价过程。

### 一个不完全市场的例子

在三叉树模型中，看涨（或看跌）期权具有多个无套利价格，原因在于无法用股票和无风险资产复制看涨期权，或者等价地说，不存在看涨期权的$\Delta$对冲。

当存在与状态有关的未定权益不能通过市场化资产的交易进行复制时，称市场是“不完全”的。

在不完全市场中，要对衍生证券进行定价，必须选择联立方程的某些特定解，并假定市场按照这些解对资产进行定价。这些类型的定价常称为均衡定价，以区别于套利定价，因为对风险中性概率进行选择时，必须给出有关投资者偏好、禀赋和生产能力的假定。（方程数少于未知数个数，故需自行增加约束以求解，相当于添加联立方程）

# 连续时间模型

## 布朗运动的模拟

```rust
use rand::Rng;
use rand_distr::StandardNormal;
use std::io;

fn main() -> io::Result<()> {
    println!("Enter the length of time(T):");
    let mut t_input = String::new();
    io::stdin().read_line(&mut t_input)?;
    let t: f64 = t_input.trim().parse().expect("please enter a valid number");

    println!("Enter the time perod(N)");
    let mut n_input= String::new();
    io::stdin().read_line(&mut n_input)?;
    let n: usize = n_input
        .trim()
        .parse()
        .expect("please enter a valid integer");

    let dt = t / n as f64;
    let sqrdt = dt.sqrt();

    let mut rng = rand::rng();
    let mut brownian_motion = 0.0;
    for i in 1..=n {
        let time = i as f64 * dt;

        let random_increment:f64 = rng.sample(StandardNormal);
        brownian_motion += random_increment * sqrdt;

        println!("{:<10.3} {:<10.6}", time, brownian_motion);
    }

    Ok(())
}

```



## 二阶变差

==为什么对布朗运动这样一个具有奇怪数学性质的过程感兴趣？==

原因在于资产定价从根本上要涉及到鞅（一个随时间变化的随机变量，其改变量的数学期望总是等于0），这一点已经反映在基本定价公式：
$$
Y(t)=S(t)E_t^S[\frac{Y(T)}{S(T)}]
$$
此外，连续过程（路径是时间的连续函数）比包含瞬间跳跃的过程在数学上更容易处理。更为重要的是，连续过程给出的数学模型比包含跳的过程更容易实现对冲。

因此，我们需要研究连续鞅过程，而任何不等于常数的鞅过程的总变差（该变量的绝对值的和）都是无穷的，这是鞅过程的一个重要结论。所以，在对连续鞅的研究中，不能采用我们熟悉的那些函数。



==在连续鞅过程中，为什么又要将研究集中在布朗运动上呢？==

任何一个连续鞅过程实际上只是布朗运动的一种变换。这个结论可以从Levy定理推出：

<u>一个连续鞅过程是布朗运动的充分必要条件是，在时间区间[0,T]上的二阶变差等于T。</u>

因此，布朗运动是[0,T]上二阶变差等于T的连续鞅过程。这实际上是一种标准化，不同的连续鞅过程会有不同的二阶变差，但经过改变时间尺度总可以把鞅过程转换为布朗运动。此外，很多连续鞅过程都可以看做是由关于布朗运动的“随机积分”构造出来的。

## ito过程

$$
dX(t)=\mu(t)dt+\sigma(t)dB(t) \tag{2.1}
$$

形如上式的Ito过程只有在$\mu=0$时才是鞅过程。

因为过程X变化量的期望值等于$\mu(t)dt$，而一个过程只有在改变量的期望等于0时才能成为鞅过程。这个结论是**推导资产定价公式的基础**。

对于一个Ito过程：
$$
\mu=0 \quad + \quad \mathbb{E}[\int^T_0 \sigma^2(t)dt]<\infty =\text{连续鞅过程} \tag{2.2}
$$
在给定0时信息条件下，时间T处的方差为
$$
var[X(T)]=\mathbb{E}[\int^T_0 \sigma^2(t)dt]<\infty
$$
*不管$\mu$是否等于0*，Ito过程X的二阶变差都以概率1等于
$$
\lim_{N \rightarrow \infty}\sum^N_{i=0}[\Delta X(t_i)]^2=\int^T_0\sigma^2(t)dt \tag{2.3}
$$
这一结论不依赖条件(2.2)。

计算二阶变差的简易法则（不严谨）：
$$
(dt)^2=0 \tag{2.4a}  
$$

$$
(dt)(dB)=0 \tag{2.4b}
$$

$$
(dB)^2=dt \tag{2.4c}
$$

二次变差更严格的数学标记：
$$
<X,X>(T)=\int^T_0 d<X,X>(t)=\int^T_0\sigma^2(t)dt \tag{2.5}
$$

## 伊藤公式

令$Y=g(B)$，则对Y进行二阶泰勒展开：
$$
\Delta Y \approx g'(B(t))\Delta B + \frac{1}{2}g''(B(t))[\Delta B]^2
$$
得到:
$$
\begin{align}
Y(T)&=Y(0)+\sum^N_{i=1}\Delta Y(t_i)\\
&\approx Y(0)+\sum^N_{i=1}g'(B(t_{i-1}))\Delta B(t_{i})+\frac{1}{2}\sum^N_{i=1}g''(B(t_{i-1}))[\Delta B(t_i)]^2
\end{align} \tag{2.8}
$$
取极限，可到伊藤公式：
$$
Y(T)=Y(0)+\int^T_0g'(B(t))dB(t)+\frac{1}{2}\int^T_0g''(B(t))dt \tag{2.7}
$$
比较：

普通函数像一辆平稳行驶的汽车，知道它的速度和方向（一阶导数）就足以预测未来的位置。

布朗运动像一辆剧烈且随机颠簸的汽车，要预测它的位置，你不仅要知道它的速度（一阶导数），还必须考虑它颠簸的剧烈程度（二阶导数，即曲率或波动率），因为这种颠簸本身会产生显著的位移。伊藤公式就是同时考虑了这两种效应的“预测公式”。

## 多维Ito过程

两个伊藤过程：
$$
dX(t)=\mu_x(t)dt+\sigma_x(t)dB_x(t) \tag{2.9a}
$$

$$
dY(t)=\mu_y(t)dt+\sigma_y(t)dB_y(t) \tag{2.9b}
$$

如果存在过程$\rho$（可能是随机过程），使得给定t时信息条件下两个正态随机变量的协方差可以表示为：
$$
E_t[\int^u_t\rho(s)ds]
$$
过程$\rho$称为两个布朗运动的相关系数。

注：即两个布朗运动增量该区间的“平均关联程度”的量化。



给定区间[0,T]上一个逐渐细化的划分$0=t_0<t_1<\cdots <t_N=T$，则当$N\rightarrow \infty$时，以概率1有：
$$
\sum^N_{i=1}\Delta B_x(t_i)\times \Delta B_y(t_i) \longrightarrow \int^T_0\rho(t)dt
$$
即可得到法则：
$$
(dB_x)(dB_y)=\rho dt
$$
可进一步证明：
$$
\begin{align}
	\lim_{N\rightarrow \infty}\sum^N_{i=1}\Delta X(t_i)\times \Delta Y(t_i)&=\int^T_0(dX)(dY)\\
	&=\int^T_0(\mu_xdt+\sigma_xdB_x)(\mu_ydt+\sigma_ydB_y)\\
	&=\int^T_0\sigma_x(t)\sigma_y(t)\rho(t)dt
\end{align}
$$
Ito公式的最一般形式，是函数$Z(t)=g(t,X(t),Y(t))$的Ito公式：
$$
Z(T)=Z(0)+\int^T_0\frac{\partial{g}}{\partial{t}}dt+\int^T_0\frac{\partial{g}}{\partial{x}}dX(t)+\int^T_0\frac{\partial{g}}{\partial{y}}dY(t)+\\
\frac{1}{2}\int^T_0\frac{\partial^2{g}}{\partial{x^2}}(dX(t))^2+\frac{1}{2}\int^T_0\frac{\partial^2{g}}{\partial{y^2}}(dY(t))^2 \\
+\int^T_0\frac{\partial^2{g}}{\partial{x}\partial{y}}(dX(t))(dY(t)) \tag{2.13}
$$
微分形式：
$$
dZ=\frac{\partial{g}}{\partial{t}}dt+\frac{\partial{g}}{\partial{x}}dX(t)+\frac{\partial{g}}{\partial{y}}dY(t)+\\
\frac{1}{2}\frac{\partial^2{g}}{\partial{x^2}}(dX(t))^2+\frac{1}{2}\frac{\partial^2{g}}{\partial{y^2}}(dY(t))^2 \\
+\frac{\partial^2{g}}{\partial{x}\partial{y}}(dX(t))(dY(t)) \tag{2.14}
$$

## 伊藤公式的几个法则

将式（2.14）中的函数分别取为$g(x,y)=xy,g(x,y)=y/x,g(x)=e^x,g(x)=\log x$

+ 乘积法则

  如果$Z=XY$,则
  $$
  dZ=XdY+YdX+(dX)(dY)
  $$
  等价于
  $$
  \frac{dZ}{Z}=\frac{dX}{X}+\frac{dY}{Y}+(\frac{dX}{X})(\frac{dY}{Y}) \tag{2.15}
  $$

+ 比值法则

  如果 $Z=Y/X$ ， 则
  $$
  \frac{dZ}{Z}=\frac{dY}{Y}-\frac{dX}{X}-(\frac{dY}{Y})(\frac{dX}{X})+(\frac{dX}{X})^2 \tag{2.16}
  $$
  
+ 指数法则

  如果$Z=e^X$ ， 则
  $$
  \frac{dZ}{Z}=dX+\frac{(dX)^2}{2} \tag{2.17}
  $$

+ 对数法则

  如果 $Z=\ln X$ ， 则
  $$
  dZ=\frac{dX}{X}-\frac{1}{2}(\frac{dX}{X})^2 \tag{2.18}
  $$

+ 复利/折现法则

  设
  $$
  Y(t)=\exp(\int^t_0 q(s)ds)
  $$
  其中q是一个过程（可以是随机过程）。对任何Ito过程，定义$Z=XY$。

  用普通微积分法则得出$dY(t)=q(t)Y(t)dt$，让上面给出的乘法法则得出
  $$
  \frac{dZ}{Z}=qdt+\frac{dX}{X} \tag{2.19}
  $$
  解释：

  虽然被积函数 *q*(*s*)可以是随机的，但**积分变量是普通的时间 ds，而不是布朗运动的微分dB(s) **

  **对每个“实现”或“路径”应用普通微积分**：

  - 我们可以这样理解：大自然首先“抽取”了一条特定的随机过程 *q*(*t*)的样本路径。对于这条特定的路径，*q*(*s*,*ω*)就变成了一个关于时间 *s*的**普通函数**（可能非常不规则，但它是确定的）。
  - 对于这个确定的被积函数，我们对时间 *s*进行积分，$∫_0^tq(s)ds$，结果是一个关于时间 *t*的**光滑函数**（因为积分对时间有平滑作用）。
  - 然后，我们对这个光滑的函数取指数，得到的 *Y*(*t*)关于时间 *t*也是一个**光滑函数**。

  在 $Y(t)$的定义中，完全没有出现 $dB(t)$。所有的随机性都被“锁”在了被积函数 *q*(*s*)里，而积分算子将$ds$其“驯化”了。**伊藤积分仅在与$dB(t)$打交道时才需要**。

## 红利再投资

结论：假定衍生证券的标的资产以“不变红利支付率”q支付红利，如果将得到的红利进行再投资购买标的资产，则标的资产数量会以q的指数增长。

证明：

考虑一个投资组合开始时由一份资产组成，持有该资产到T，其间的红利进行再投资。设$X(t)$表示该投资组合中股票的份数，$t\leq T$，则在时间t得到的红利为$qS(t)X(t)dt$，用红利可以购买的新股票数为$qX(t)dt$。由此得出$dX(t)=qX(t)dt$，或者$dX(t)/dt=qX(t)$，容易验证该微分方程的解为$X(t)=e^{qt}X(0)$，其中$X(0)=1$。由此得出$X(t)=e^{qt}$。

因为所支付红利进行了再投资，因此$V(t)$是不支付红利的投资组合价值。即：**持有并进行股息再投资的支付股息证券 `S(t)`，在价值上完全等价于持有一个人造的、不支付股息但价值为 $V(t) = e^{qt}S(t)$的证券**

在金融建模（尤其是期权定价）中，处理不支付股息的资产（如不派息的股票）的模型要简单得多。这个等价关系允许我们将复杂的支付股息资产的问题，转化为我们已熟知如何解决的、更简单的无股息资产问题。

这个等价关系的价值增长率：
$$
\frac{dS}{S}=qdt+\frac{dS}{S} \tag{2.20}
$$
即投资者的收益率等于红利支付率加上资本利得收益。

## 几何布朗运动

$$
S(t)=S(0)\exp(\mu t-\sigma^2t/2+\sigma B(t)) \tag{2.21}
$$

其中$\mu$和$\sigma$为常数，$B$为布朗运动。采用乘积法则和指数法则得出：
$$
\frac{dS}{S}=\mu dt+\sigma dB \tag{2.22}
$$
(2.21)是(2.22)的解。

把（2.22）解释为在dt瞬间，S的期望变化率为$\mu dt$，变化率方差为$\sigma^2 dt$。

将（2.21）取自然对数，得出另一种等价形式
$$
\log S(t)=\log S(0)+(\mu-\frac{1}{2}\sigma^2)t+\sigma B(t) \tag{2.23}
$$
微分形式为：
$$
d\log S(t)=(\mu-\frac{1}{2}\sigma^2)dt+\sigma dB(t) \tag{2.24}
$$
因此，（2.22）和（2.24）等价：
$$
\frac{dS}{S}=\mu dt+\sigma dB \quad  \Leftrightarrow \quad d\log S(t)=(\mu-\frac{1}{2}\sigma^2)dt+\sigma dB(t)
$$


又
$$
\frac{S(t_i)}{S(t_{i-1})}=e^{r_i\Delta t} \quad \Longrightarrow \quad\Delta \log S=r_i\Delta t \quad \Longrightarrow \quad r_i=\mu-\frac{1}{2}\sigma^2+\frac{\sigma\Delta B}{\Delta t}
$$
这说明 $r_i \sim \mathcal{N}(\mu-\frac{1}{2}\sigma^2,\sigma^2/\Delta t)$

如果给出收益率的历史数据，采用标准的估计方法可以估计出参数$\mu$和$\sigma$



模拟路径

```rust
use rand::Rng;
use rand_distr::StandardNormal;
use std::io;
fn main() ->io::Result<()>{
    println!("Enter the time range(T):");
    let mut T_input=String::new();
    io::stdin().read_line(&mut T_input)?;
    let t:f64=T_input.trim().parse().expect("Please type a number!");

    println!("Enter the time period(N):");
    let mut N_input=String::new();
    io::stdin().read_line(&mut N_input)?;
    let n:usize=N_input.trim().parse().expect("Please type a integar!");

    println!("Enter the S0:");
    let mut S_input=String::new();
    io::stdin().read_line(&mut S_input)?;
    let s:f64=S_input.trim().parse().expect("Please type a number!");

    println!("Enter the mu:");
    let mut mu_input=String::new();
    io::stdin().read_line(&mut mu_input)?;
    let mu:f64=mu_input.trim().parse().expect("Please type a number!");

    println!("Enter the sigma:");
    let mut sigma_input=String::new();
    io::stdin().read_line(&mut sigma_input)?;
    let sigma:f64=sigma_input.trim().parse().expect("Please type a number!");

    let time=t / n as f64;
    let sqrtime=time.sqrt();
    let mut logS=s.ln();
    println!("{:<10.3} {:<10.6}", 0 as f64, s);
    let mut rng=rand::rng();
    for i in 1..=n{
        let cur=i as f64 *time;

        let r=rng.sample::<f64,StandardNormal>(StandardNormal);
        logS+=(mu-0.5*sigma*sigma)*time+sigma*sqrtime*r;
        println!("{:<10.3} {:<10.6}", cur, logS.exp());
    }

    Ok(())
}
```

## 计价物和概率

当概率测度改变时，不能保证布朗运动B仍然是布朗运动。布朗运动变化量的数学期望总是等于0，但当概率改变后，B的变化量的数学期望很可能不再等于0（同样，在概率测度改变后，一个鞅过程很可能不再是一个鞅过程）。

但是，在新的测度下，布朗运动B仍然是一个Ito过程。实际上，在一个概率测度下的Ito过程，在新的概率测度下仍然是Ito过程，并且Ito过程的扩散系数不受概率测度改变的影响。**概率测度的改变只影响Ito过程的漂移项**。

改变概率测度会影响不同路径的概率（因此会影响B变化量的期望），但不会改变各个路径上下波动的方式。因此，在新的测度下，B仍然很像一个布朗运动，只是漂移项不再是0。以及Ito过程之间的瞬间协方差--$(dX)(dY)$项也不受概率测度变化的影响。

资产定价中需要知道不同计价物下标的资产的分布。

引入三种资产

+ 资产价格为S，且资产的红利支付率为常数q

  令$V(t)=e^{qt}S(t)$为投资组合的价格，投资组合的所有红利都进行再投资，则V(t)满足：
  $$
  V(t)=qdt+\frac{dS}{S}\\
  \frac{dS}{S}=\mu_sdt+\sigma_sdB_s
  $$

+ 不发放红利的资产Y
  $$
  \frac{dY}{Y}=\mu_ydt+\sigma_ydB_y
  $$
  
+ 无风险资产R
  $$
  R(t)=\exp(\int^t_sr(s)ds)
  $$
  其中$B_s,B_y$是实际概率测度下的布朗运动，相关系数为$\rho,\quad\mu_s、\mu_y、\sigma_s、\sigma_y、\rho$是一般的随机过程。

  对于资产价格S在三种不同概率测度下的动态变化，在每种情形中，我们都遵照如下步骤进行：

  1. 资产价格与计价物资产价格的比值必须为鞅过程；
  2. 用Ito公式计算比值的漂移项；
  3. 用鞅过程的漂移项为0这一性质计算dS/S的漂移项

### 风险中性概率

以无风险资产作为计价物，即为风险中性概率，此时
$$
Z(t)=\frac{V(t)}{R(t)}=\exp(-\int^t_0r(s)ds)V(t)
$$
为鞅过程。利用复利/折现法则得出：
$$
\frac{dZ}{Z}=-rdt+\frac{dV}{V}=(q-r)dt+\frac{dS}{S}=(q-r+\mu^*_s)dt+\sigma_sdB^*_s
$$
要使Z成为鞅过程，dZ/Z的漂移项(dt项)必须为0，因此$\mu^*_s=r-q$ ，即：
$$
\frac{dS}{S}=(r-q)dt+\sigma_sdB^*_s \tag{2.27}
$$
其中$B^*_s$是风险中性概率测度下的布朗运动



### 以标的资产为计价物

以V为计价物时，由
$$
Z(t)=\frac{R(t)}{V(t)}=\frac{\exp(\int^t_0r(s)ds)}{V(t)}
$$
定义的过程$Z(t)$是鞅过程。利用比值法则得出
$$
\frac{dZ}{Z}=rdt-\frac{dV}{V}+(\frac{dV}{V})^2=(r-q+\sigma^2_s)dt-\frac{dS}{S}
$$
从$dZ/Z$的漂移项必须为0得出，$dS/S$的漂移项为$(r-q+\sigma^2_s)dt$，由此得出
$$
\frac{dS}{S}=(r-q+\sigma^2_s)dt+\sigma_sdB^*_s \tag{2.28}
$$
其中$B^*_s$表示以$V(t)=e^{qt}S(t)$为计价物时的布朗运动。

注：这种情况是以与自己等价的无红利支付的投资组合作为计价物的情况下计算得出的标的资产的漂移项

### 以另一种风险资产为计价物

当以Y为计价物时，以
$$
Z(t)=\frac{V(t)}{Y(t)}
$$
定义的$Z(t)$为鞅过程。再次采用比值法则得出
$$
\begin{align}
	\frac{dZ}{Z}&=\frac{dV}{V}-\frac{dY}{Y}-(\frac{dV}{V})(\frac{dY}{Y})+(\frac{dY}{Y})^2\\
	&=\frac{dV}{V}-\frac{dY}{Y}-\rho\sigma_s\sigma_ydt+\sigma^2_ydt\\
	&=\frac{dS}{S}-\frac{dY}{Y}+(q-\rho\sigma_s\sigma_y+\sigma^2_y)dt
\end{align}
$$
参照第二张情况，计算在以与自身等价的无红利支付的资产作为计价物时，对应的概率测度下自身的漂移项，因为Y资产本身就不支付红利，故自己与自己等价，即（2.28）中q=0的情形，所以$dY/Y$的漂移项为$(r+\sigma_y^2)dt$.

从$dZ/Z$的漂移项必须是0得出如下结论：
$$
\frac{dS}{S}=(r-q+\rho\sigma_s\sigma_y)dt+\sigma_sdB^*_s \tag{2.29}
$$
其中$B_s^*$表示以不支付红利的资产Y为计价物时对应的概率测度下的布朗运动，$\rho$为S和Y之间的相关系数。

（2.27）和（2.28）是（2.29）的特例：1.Y是无风险资产时，$\sigma_y=0$；2.如果Y是V，则$\sigma_y=\sigma_s,\rho=1$

## 几何布朗运动的尾部概率

对每一种计价物，都存在$\alpha,\sigma$以及对应的概率测度下的布朗运动$B$，使得
$$
d\log S=\alpha dt+\sigma dB \tag{2.32}
$$
根据上一节的讨论，具体情况是，$\sigma=\sigma_s,B=B^*_s$，并且

1. 对风险中性概率测度，$\alpha=r-q-\sigma^2_s/2$;
2. 以$e^{qt}S(t)$为计价物，$\alpha=r-q+\sigma^2_s/2$
3. 以另一个风险资产价格Y为计价物，$\alpha=r-q+\rho \sigma_s \sigma_y-\sigma^2_s/2$

期权定价中的关键问题，是对给定的常数K（期权执行价格）计算$prob(S(T)>K)$和$prob(S(T)<K)$，这里prob表示特定计价物下时间0处（即给期权定价的时间）的概率。

由(2.32)得出：
$$
\log S(T)=\log S(0)+\alpha T +\sigma B(T)
$$
由此得出：
$$
\begin{align}
	S(T)>K &\Leftrightarrow \log S(T)>\log K\\
	&\Leftrightarrow \sigma B(T)>\log K - \log S(0) -\alpha T\\
	&\Leftrightarrow \frac{B(T)}{\sqrt{T}}>\frac{\log K - \log S(0) -\alpha T}{\sigma \sqrt{T}}\\
	&\Leftrightarrow -\frac{B(T)}{\sqrt{T}}<\frac{  \log S(0)-\log K+\alpha T}{\sigma \sqrt{T}}\\
	&\Leftrightarrow -\frac{B(T)}{\sqrt{T}}<\frac{  \log (S(0)/K)+\alpha T}{\sigma \sqrt{T}}
\end{align} \tag{2.33}
$$
式（2.33）左边服从标准正态分布，由此得出：

设$d\log S=\alpha dt+\sigma dB$, $B$为布朗运动。则对任何数K，
$$
prob(S(T)>K)=N(d) \tag{2.34}
$$

$$
prob(S(T)<K)=N(-d) \tag{2.36}
$$

其中
$$
d=\frac{  \log (S(0)/K)+\alpha T}{\sigma \sqrt{T}} \tag{2.35}
$$

## 波动率

我们把方程
$$
\frac{dS}{S}=\mu dt+\sigma dB
$$
中的$\sigma$称为“S的波动率”，其中B是布朗运动。

设
$$
\frac{dX}{X}=\mu_x dt + \sigma_x dB_x,\frac{dY}{Y}=\mu_y dt + \sigma_y dB_y
$$
其中$B_x,B_y$为两个布朗运动，它们之间的相关系数为$\rho$

+ 随机过程乘积的波动率

  如果$Z=XY$，由（2.15）得出
  $$
  \frac{dZ}{Z}=(\mu_x+\mu_y+\rho \sigma_x \sigma_y)dt+\sigma_x dB_x +\sigma_y dB_y \tag{2.37}
  $$
  dZ/Z波动的来源为$\sigma_x dB_x +\sigma_y dB_y$，故其瞬间方差为：
  $$
  \begin{align}
  	(\frac{dZ}{Z})^2&=(\sigma_x dB_x +\sigma_y dB_y)^2\\
  	&=(\sigma_x^2+\sigma_y^2+2\rho\sigma_x \sigma_y)dt
  \end{align}
  $$
  波动率等于瞬间方差（去掉dt）的平方根，由此得出

  XY的波动率为：$\sqrt{\sigma_x^2+\sigma_y^2+2\rho\sigma_x \sigma_y}$

+ 随机过程比值的波动率

  如果$Z=Y/X$，由（2.16）得出
  $$
  \frac{dZ}{Z}=(\mu_y-\mu_x-\rho \sigma_x \sigma_y + \sigma_x^2)dt+\sigma_y dB_y-\sigma_xdB_x \tag{2.39}
  $$
  由此得出dZ/Z的瞬间方差为
  $$
  \begin{align}
  	(\frac{dZ}{Z})^2&=(\sigma_x dB_x -\sigma_y dB_y)^2\\
  	&=(\sigma_x^2+\sigma_y^2-2\rho\sigma_x \sigma_y)dt
  \end{align}
  $$
  即Y/X的波动率为$\sqrt{\sigma_x^2+\sigma_y^2-2\rho\sigma_x \sigma_y} $

# Black-Scholes

数字期权和股份数字期权是构成看涨期权和看跌期权的基本元素。

## 数字期权

+ $S(T)>K$则支付$1的情况

$$
x=\begin{cases} 1\quad \text{if }S(T)>K \\0 \quad \text{else}\end{cases}
$$

由风险中性定价公式（1.18）可知，数字期权在时刻0的价值为$e^{-rT}\mathbb{E}^R[x]$。由于
$$
\begin{align}
\mathbb{E}^R[x]&=1 \times \text{prob}^R(x=1)+0 \times \text{prob}^R(x=0)\\
&=\text{prob}^R(x=1)\\
&=\text{prob}^R(S(T)>K)
\end{align}
$$
由（2.27），以及Black-Scholes假设$\frac{dS}{S}=\mu dt + \sigma dB$下，有
$$
\frac{dS}{S}=(r-q)dt+\sigma dB^* 
$$
等价于
$$
d\log S=(r-q-\frac{1}{2}\sigma^2)dt+\sigma dB^*
$$
采用（2.34）-（2.35），并取其中的$\alpha=r-q-\sigma^2/2$，得出
$$
\text{prob}^R(S(T)>K)=N(d_2)\\
\text{其中： }d_2=\frac{\log(\frac{S(0)}{K})+(r-q-\frac{1}{2}\sigma^2)T}{\sigma\sqrt{T}} \tag{3.2}
$$
从而：

> $S(T)>K$时支付$1的数字期权的价值为$$e^{-rT}N(d_2)$，其中$d_2$由（3.2）给出。

+ $S(T)<K$则支付$1的情况

$$
y=\begin{cases} 1\quad \text{if }S(T)<K \\0 \quad \text{else}\end{cases}
$$

再次应用风险中性定价公式，得出数字期权在0时的价值为
$$
e^{-rT}\mathbb{E}^R[y]=e^{-rT}\text{prob}^R(y=1)=e^{-rT}\text{prob}^R(S(T)<K)
$$
由（2.36）可得

> $S(T)<K$时支付$1的数字期权的价值为$$e^{-rT}N(-d_2)$，其中$d_2$由（3.2）给出。

## 股份数字期权

+ $S(T)>K$则支付一份标的资产的情况

$$
x=\begin{cases} 1\quad \text{if }S(T)>K \\0 \quad \text{else}\end{cases}
$$

则股份数字期权在时间T的回报为$xS(T)$。设$Y(t)$表示这个未定权益的价格，$0 \leq t \leq T$，则$Y(T)=xS(T)$，现计算$Y(0)$。

以$V(t)=e^{qt}S(t)$作为计价物，从基本定价公式（1.17）得出。
$$
Y(0)=S(0)\mathbb{E}^V[\frac{Y(T)}{e^{qT}S(T)}]=e^{-qT}S(0)\mathbb{E}^V[x]=e^{-qT}S(0)\text{prob}^T(x=1)
$$
由（2.28），得出
$$
\frac{dS}{S}=(r-q+\sigma^2)dt+\sigma dB^*
$$
等价于
$$
d\log S=(r-q+\frac{1}{2}\sigma^2)dt+\sigma dB^* \tag{3.3}
$$
采用（2.34）-（2.35），并取其中的$\alpha=r-q+\sigma^2/2$，得出
$$
\text{prob}^V(S(T)>K)=N(d_1)\\
\text{其中： }d_1=\frac{\log(\frac{S(0)}{K})+(r-q+\frac{1}{2}\sigma^2)T}{\sigma\sqrt{T}} \tag{3.4}
$$
从而：

> $S(T)>K$时支付一份标的资产的股份数字期权的价值为$e^{-qT}S(0)N(d_1)$，其中$d_1$由（3.4）给出。

+ $S(T)<K$则支付一份标的资产的情况

$$
y=\begin{cases} 1\quad \text{if }S(T)<K \\0 \quad \text{else}\end{cases}
$$

则股份数字期权在时间T的回报为$yS(T)$，得出数字股份期权在0时的价值为
$$
e^{-qT}S(0)\mathbb{E}^V[y]=e^{-qT}S(0)\text{prob}^V(y=1)=e^{-qT}S(0)\text{prob}^V(S(T)<K)
$$
由（2.36）可得

> $S(T)<K$时支付一份标的资产的股份数字期权的价值为$e^{-qT}S(0)N(-d_1)$，其中$d_1$由（3.4）给出。

## 看跌期权和看涨期权

+ 欧式看涨期权

在时间T，如果$S(T)>K$，一份欧式看涨期权的回报为$S(T)-K$，否则为0.令
$$
x=\begin{cases}
1\quad \text{if } S(T)>K\\ 0 \quad \text{else}
\end{cases}
$$
看涨期权的回报函数可以表示为$xS(T)-xK$，等价于一份股份数字期权减去K份数字期权，该数字期权在事件$S(T)>K$发生时进行支付。股份数字期权的0时价值为$e^{-qT}S(0)N(d_1)$，数字期权的价值为$e^{-rT}N(d_2)$。从（3.2）和（3.4）可以得出，$d_1$和$d_2$具有关系$d_2=d_1-\sigma\sqrt{T}$,综上可得出Black-Scholes公式：

欧式看涨期权在0时的价值为
$$
e^{-qT}S(0)N(d_1)-e^{-rT}KN(d_2) \tag{3.5}
$$

+ 欧式看跌期权

  欧式看跌期权在T时的回报为：如果$S(T)<K$，回报为$K-S(T)$，否则为0。设
  $$
  y=\begin{cases} 1 \quad \text{if } S(T)<K\\0 \quad \text{else}\end{cases}
  $$
  看跌期权的回报函数为$yK-yS(T)$，这等价于K份数字期权减去一份数字股份期权，两个期权在$S(T)<K$时进行支付。由此得出

  欧式看跌期权在0时的价值为
  $$
  e^{-rT}KN(-d_2)-e^{-qT}S(0)N(-d_1) \tag{3.6}
  $$

+ 欧式期权看跌看涨平均关系（CCP）
  $$
  e^{-rT}K+看涨期权价格=e^{-qT}S(0)+看跌期权价格
  $$

  ## 希腊字母

  |   变量   | Input Symbol | 希腊字母 | 希腊字母符号 |
  | :------: | :----------: | :------: | :----------: |
  | 股票价格 |      S       |  delta   |      δ       |
  |  德尔塔  |      δ       |  gamma   |      Γ       |
  | - 到期日 |      -T      |  theta   |      Θ       |
  |  波动率  |      σ       |   vega   |      V       |
  |   利率   |      r       |   rho    |      ρ       |

  其中希腊字母Θ是关于-T的导数而不是关于T的导数，原因在于到期时间T的减少（-T的增加）等价于时间的流逝，因此Θ衡量的是时间流逝对期权价格的影响。

  正态分布函数N的导数是正态密度函数n，即
  $$
  n(d)=\frac{1}{\sqrt{2\pi}}e^{-\frac{-d^2}{2}}
  $$
  容易验证
  $$
  e^{-qT}Sn(d_1)=e^{-rT}Kn(d_2) \tag{3.8}
  $$
  以欧式看涨期权为例计算希腊字母

  $$ \begin{align*} \delta &= \mathrm{e}^{-qT} \mathrm{N}(d_1) + \mathrm{e}^{-qT} S \mathrm{n}(d_1) \frac{\partial d_1}{\partial S} - \mathrm{e}^{-rT} K \mathrm{n}(d_2) \frac{\partial d_2}{\partial S} \\ &= \mathrm{e}^{-qT} \mathrm{N}(d_1) + \mathrm{e}^{-qT} S \mathrm{n}(d_1) \left( \frac{\partial d_1}{\partial S} - \frac{\partial d_2}{\partial S} \right) \\ &= \mathrm{e}^{-qT} \mathrm{N}(d_1), \end{align*} $$

  $$ \Gamma = \mathrm{e}^{-qT} \mathrm{n}(d_1) \frac{\partial d_1}{\partial S} = \mathrm{e}^{-qT} \mathrm{n}(d_1) \frac{1}{S\sigma\sqrt{T}}, $$

  $$ \begin{align*} \Theta &= -\mathrm{e}^{-qT} S \mathrm{n}(d_1) \frac{\partial d_1}{\partial T} + q\mathrm{e}^{-qT} S \mathrm{N}(d_1) \\ &\quad + \mathrm{e}^{-rT} K \mathrm{n}(d_2) \frac{\partial d_2}{\partial T} - r\mathrm{e}^{-rT} K \mathrm{N}(d_2) \\ &= \mathrm{e}^{-qT} S \mathrm{n}(d_1) \left( \frac{\partial d_2}{\partial T} - \frac{\partial d_1}{\partial T} \right) \\ &\quad + q\mathrm{e}^{-qT} S \mathrm{N}(d_1) - r\mathrm{e}^{-rT} K \mathrm{N}(d_2) \\ &= -\mathrm{e}^{-qT} S \mathrm{n}(d_1) \frac{\sigma}{2\sqrt{T}} + q\mathrm{e}^{-qT} S \mathrm{N}(d_1) - r\mathrm{e}^{-rT} K \mathrm{N}(d_2), \end{align*} $$

  $$ \begin{align*} \rho &= \mathrm{e}^{-qT} S \mathrm{n}(d_1) \frac{\partial d_1}{\partial r} - \mathrm{e}^{-rT} K \mathrm{n}(d_2) \frac{\partial d_2}{\partial r} + T\mathrm{e}^{-rT} K \mathrm{N}(d_2) \\ &= \mathrm{e}^{-qT} S \mathrm{n}(d_1) \left( \frac{\partial d_1}{\partial r} - \frac{\partial d_2}{\partial r} \right) + T\mathrm{e}^{-rT} K \mathrm{N}(d_2) \\ &= T\mathrm{e}^{-rT} K \mathrm{N}(d_2). \end{align*} $$

  

根据看涨-看跌平价公式可以计算出看跌期权的希腊字母。

## 德尔塔对冲

无套利定价得出BS公式的关键，在于用股票和期权构造一个完全对冲（无风险）投资组合。为实现完全对冲，必须随时对投资组合进行调整，因为$\delta$值会随标的资产变化和时间的推移而变化。即使所有模型假设都满足，实际中的对冲也不可能是完全对冲。

考虑到期日为T的一份欧式看涨期权，用$C(S,t)$表示时间t处股票价格为S的期权价格。考虑由一份看涨期权空头和$\delta$份标的资产多头形成的投资组合。同时考虑由$C-\delta S$的现金（空头）组成的投资组合，该投资组合在0时的价值为0。

投资组合价值在时间间隔dt的瞬间改变量为
$$
-dC+\delta dS + q\delta S dt+(C-\delta S)r dt \tag{3.9}
$$
第一项反映了期权自身价值的变化，第二项是持有δ份股票所产生的资本利得或损失，第三项是这δ份股票带来的股息收入，而第四项则是空头现金头寸所产生的利息费用。

另一方面，从伊藤公式得出
$$
\begin{align}
dC=&\frac{\partial{C}}{\partial{S}}dS+\frac{\partial{C}}{\partial{t}}dt+\frac{1}{2}\frac{\partial^2{C}}{\partial{S^2}}(dS)^2\\
&=\delta dS +\Theta dt+\frac{1}{2}\Gamma \sigma^2S^2 dt 
\end{align}\tag{3.10}
$$
将（3.10）带入(3.9)，得出投资组合价值的变化为
$$
-\Theta \, \mathrm{d}t - \frac{1}{2}\Gamma \sigma^2 S^2 \, \mathrm{d}t + q\delta S \, \mathrm{d}t + (C - \delta S)r \, \mathrm{d}t. \tag{3.11}
$$
德尔塔对冲消除了标的资产价格变化带来的风险暴露，所以（3.11）没有dS项。其次，$\Theta$时负的，它衡量了期权时间价值的减少；期权空头将从到期时间的减少中获利，时间每减少一个单位所带来的获利为$-\Theta$。这样的投资组合时“伽玛空头”组合，也称为“凸性空头”投资组合。股票价格的波动使得凸性具有价值，凸性空头的投资组合将遭受损失。最后，投资组合得到红利，但支出利息。

带入各希腊字母的定义，可知，（3.11）中各项之和为0.时间减少导致的期权价值变化和来自标的资产的红利收入，正好可以对冲掉凸性损失和利息支出。因此，<u>德尔塔对冲是完全对冲的</u>。

## 伽玛对冲

在离散的德尔塔对冲中，为了改善对冲效果，可以用另外的期权构建德尔塔中性和伽玛中性的投资组合。

伽玛中性的含义是，投资组合的德尔塔不存在关于标的资产价格变化的风险暴露，这等价于投资组合价值关于标的资产价格的二阶导数等于0。如果德尔塔真的不发生变化，则没有必要对投资组合进行连续调整，但是，并不能保证离散调整的德尔塔/伽玛对冲比离散调整的德尔塔对冲好。

> **金融工程中没有“免费的午餐”**。
>
> 不能保证的几个原因：
>
> a) **高阶风险暴露**
>
> Delta是价值对价格的一阶导数，Gamma是二阶导数。但风险并没有在三阶停止。还有**三阶导数**，通常称为**Speed**或 **Gamma的导数**，它衡量Gamma本身的变化速度。当一个大幅价格变动发生时，不仅Delta会变，Gamma本身也会改变。一个在初始时刻Delta和Gamma中性的组合，可能会因为Gamma的改变而立刻产生新的Delta和Gamma风险。要管理这个风险，就需要引入第三种资产，使得组合对三阶导也中性，但这会极大地增加复杂性、成本和模型风险。
>
> b) **交易成本和复杂性**
>
> 构建Gamma中性组合需要引入**第二种期权**。这意味着：
>
> - **更高的交易成本**：需要多交易一种流动性可能较差的金融工具。
>
> - **更高的管理复杂度**：你需要同时监控和管理两个期权头寸的Delta、Gamma、Vega（波动率风险）等。
>
>   这些额外的成本和复杂性可能会“吃掉”Gamma中性可能带来的任何理论优势。有时，简单地更频繁地调整Delta对冲（即进行离散的Delta再平衡），可能比维持一个复杂的Delta/Gamma中性组合更经济、更有效。
>
> c) **模型风险**
>
> 无论是计算Delta还是Gamma，都严重依赖于所使用的期权定价模型（如布莱克-斯科尔斯模型）。这些模型基于一系列假设（如波动率恒定、市场连续等），而这些假设在现实中并不完全成立。如果模型本身有缺陷，那么基于模型计算出的“中性”头寸从一开始就是错的。一个基于错误模型构建的、看似更复杂的对冲策略，其表现可能还不如一个简单的策略。
>
> d) **其他风险暴露**
>
> Delta/Gamma对冲主要针对“方向性风险”。但投资组合还暴露在其他风险之下，最典型的是**Vega风险**，即对波动率的敏感性。在构建Delta/Gamma中性组合时，你很可能无意中改变了组合对波动率的暴露。如果市场波动率发生意外变化，这个对冲组合的表现可能会出乎意料地差。
>
> 总结：
>
> - **Delta对冲**：简单，但需要频繁再平衡，对离散调整敏感。
> - **Delta/Gamma对冲**：试图减少再平衡频率和对离散调整的敏感度，但引入了**更高阶的风险、更高的成本、更复杂的模型依赖以及新的风险暴露（如Vega）**。
>
> 因此，**“没有保证”**意味着，在现实世界中，第二种策略所引入的新问题和成本，完全有可能超过它所能解决的问题。最终哪种策略表现更好，取决于具体市场环境（价格是平滑变动还是跳跃式变动）、交易成本、以及模型准确性等多种因素，其结果是不确定的。

构造德尔塔/伽玛对冲组合：

假定卖出一份看涨期权，并打算用标的资产和零一份期权进行德尔塔对冲和伽玛对冲，比如采用零一分执行价格不同的看涨期权进行对冲。实践中，需要用一个流动性期权来达到这个目的。==所谓流动性期权是指期权执行价格接近标的资产当前价格的期权（即用于对冲的期权是近似平价期权）。==

设$\delta$和$\Gamma$表示卖出期权的德尔塔和伽玛，$\delta$'和$\Gamma$' 表示对冲期权的德尔塔和伽玛。考虑用a份股票和b份期权对卖出期权实施对冲。股票的德尔塔等于1（dS/dS=1),因此要得到0德尔塔投资组合，需要满足：
$$
0=-\delta+a+b\delta ' \tag{3.12}
$$
股票的伽玛为0（$d^2S/dS^2=d1/dS=0$)，因此要得到0伽玛的投资组合，需要满足：
$$
0=-\Gamma+b\Gamma ' \tag{3.13}
$$
（3.13）表明应该持有足够的用于对冲的第二种期权，使得卖出的期权空头具有伽玛中性，即：
$$
b=\frac{\Gamma}{\Gamma'}
$$
从而得到：
$$
a=\delta-\frac{\Gamma}{\Gamma'}\delta '
$$

## 隐含波动率

BS公式给出了期权价格和波动率之间的一一对应关系，因此可以在价格给定时从公式中推出$\sigma$，用这种方法计算出来的$\sigma$称为“隐含波动率”。从一个期权中得出的隐含波动率可用于另一个期权（也许是没有交易或交易很不活跃的期权）定价。

甚至在我们承认模型是不准确的情况下，隐含波动率的计算对于了解市场价格仍然是有用处的，因为**根据波动率的大小，可以迅速判断一份期权是“贵”还是“便宜”**。不能从期权的价格判断期权是贵还是便宜，因为期权的价格必须由执行价格和到期时间综合考虑。==一定程度上，隐含波动率用执行价格和到期时间将期权价格标准化==。

## 波动率期限结构

当实际当中的波动率不是常数，是一个非随机的时间函数时，期权定价公式仍然有效，此时$\log S(T)$的方差是：
$$
\int^T_0 \sigma^2(t)dt \tag{3.14}
$$
这个积分实际上是瞬间方差$\sigma^2(t)dt$的和。



